# 百度千帆模型集成开发文档

## 1. 功能概述

### 1.1 功能名称
百度千帆模型集成 (Baidu Qianfan Model Integration)

### 1.2 功能描述
百度千帆模型集成功能旨在将百度千帆平台的多种AI图像处理模型集成到302.AI图片工具箱中，为用户提供丰富多样的AI图像处理选项。百度千帆提供了包括文生图、图像编辑、视频生成等多种功能，支持多种模型如ernie-irag-edit、qwen-image-edit、musesteamer系列等。

### 1.3 目标用户
- 需要多样化图像处理功能的用户
- 对百度千帆模型有特定需求的设计师和内容创作者
- 希望在统一平台使用多种AI模型的开发者

## 2. 功能需求

### 2.1 核心功能
1. **文生图功能**：支持通过文本描述生成图像，支持irag-1.0、flux.1-schnell、qwen-image等模型
2. **图像编辑功能**：支持对图像进行编辑，支持ernie-irag-edit、qwen-image-edit模型
3. **视频生成功能**：支持使用图像和文本生成视频，支持musesteamer系列模型
4. **参数配置**：支持图像分辨率、生成数量等参数配置
5. **反向提示词**：支持negative_prompt参数，排除不希望出现的内容
6. **智能改写**：支持prompt智能改写功能
7. **水印添加**：支持添加水印标识

### 2.2 用户界面需求
1. 模型选择下拉菜单
2. 图像参数配置控件（分辨率、生成数量等）
3. 文本输入框（提示词、反向提示词）
4. 图像上传区域
5. 掩码编辑工具（用于图像编辑功能）
6. 视频生成参数设置（时长、特效等）
7. 预览区域

## 3. 技术实现方案

### 3.1 技术架构
```
前端组件层:
- QianfanModelSelector.tsx (模型选择组件)
- QianfanControls.tsx (参数控制面板)
- QianfanImageGenerator.tsx (图像生成主组件)
- QianfanImageEditor.tsx (图像编辑组件)
- QianfanVideoGenerator.tsx (视频生成组件)

状态管理层:
- Zustand store (扩展全局状态)
- qianfanSlice.ts (百度千帆功能状态)

API层:
- lib/api.ts (新增百度千帆API调用)
- utils/Qianfan.ts (百度千帆工具函数)

类型定义层:
- types/index.ts (新增类型定义)
```

### 3.2 API接口设计
```typescript
// 百度千帆通用API接口
interface QianfanAction {
  prompt?: string;
  negativePrompt?: string;
  model: string; // 模型名称
  size?: string; // 图像分辨率
  n?: number; // 生成图片数量
  promptExtend?: boolean; // 是否开启prompt智能改写
  watermark?: boolean; // 是否添加水印
  seed?: number; // 随机数种子
  steps?: number; // 采样步数
  guidance?: number; // 指导密度值
  referImage?: string; // 参考图图片链接
  image?: string; // 需要编辑的图片链接
  mask?: string; // 控制图像编辑的区域
  feature?: string; // 图像编辑功能类型
  duration?: number; // 视频生成时长
  content?: Array<{type: string, text?: string, image_url?: {url: string}}>; // 视频生成内容
  modelParameters?: {effectScene?: string, useBgAudio?: boolean}; // 模型特定参数
  // 其他特定模型参数
  [key: string]: any;
}

interface QianfanResult {
  imageUrls: string[]; // 生成的图像URL列表
  videoUrl?: string; // 生成的视频URL
  taskId?: string; // 任务ID
  processingTime?: number; // 处理时间(ms)
  actualPrompt?: string; // 实际使用的提示词（开启智能改写时）
  [key: string]: any; // 其他特定模型返回数据
}

// 主要API函数
export async function qianfanGenerateImage(action: QianfanAction): Promise<QianfanResult> {
  // 实现百度千帆图像生成逻辑
}

export async function qianfanEditImage(action: QianfanAction): Promise<QianfanResult> {
  // 实现百度千帆图像编辑逻辑
}

export async function qianfanGenerateVideo(action: QianfanAction): Promise<QianfanResult> {
  // 实现百度千帆视频生成逻辑
}

// 任务状态查询API
interface QianfanTaskStatus {
  taskId: string;
  taskStatus: 'PENDING' | 'RUNNING' | 'SUCCEEDED' | 'FAILED' | 'CANCELED' | 'UNKNOWN';
  results?: Array<{ url: string }>;
  [key: string]: any; // 其他特定模型返回数据
}

export async function getQianfanTaskStatus(taskId: string): Promise<QianfanTaskStatus> {
  // 查询百度千帆任务状态
}
```

### 3.3 组件设计

#### 3.3.1 模型选择组件 QianfanModelSelector.tsx
```tsx
import React from 'react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';

interface QianfanModelSelectorProps {
  value: string;
  onChange: (model: string) => void;
}

export function QianfanModelSelector({ value, onChange }: QianfanModelSelectorProps) {
  const models = [
    // 文生图模型
    { name: 'IRAG 1.0', value: 'irag-1.0' },
    { name: 'Flux.1 Schnell', value: 'flux.1-schnell' },
    { name: 'Qwen Image', value: 'qwen-image' },
    
    // 图像编辑模型
    { name: 'Ernie Irag Edit', value: 'ernie-irag-edit' },
    { name: 'Qwen Image Edit', value: 'qwen-image-edit' },
    
    // 视频生成模型
    { name: 'MuseSteamer 2.0 Turbo I2V Audio', value: 'musesteamer-2.0-turbo-i2v-audio' },
    { name: 'MuseSteamer 2.0 Turbo I2V', value: 'musesteamer-2.0-turbo-i2v' },
    { name: 'MuseSteamer 2.0 Lite I2V', value: 'musesteamer-2.0-lite-i2v' },
    { name: 'MuseSteamer 2.0 Pro I2V', value: 'musesteamer-2.0-pro-i2v' },
    { name: 'MuseSteamer 2.0 Turbo I2V Effect', value: 'musesteamer-2.0-turbo-i2v-effect' },
  ];

  return (
    <div className="qianfan-model-selector">
      <label>选择模型</label>
      <Select value={value} onValueChange={onChange}>
        <SelectTrigger>
          <SelectValue placeholder="选择百度千帆模型" />
        </SelectTrigger>
        <SelectContent>
          {models.map((model) => (
            <SelectItem key={model.value} value={model.value}>
              {model.name}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>
    </div>
  );
}
```

#### 3.3.2 参数控制面板 QianfanControls.tsx
```tsx
import React from 'react';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Slider } from '@/components/ui/slider';
import { Switch } from '@/components/ui/switch';
import { Textarea } from '@/components/ui/textarea';
import { QianfanModelSelector } from './QianfanModelSelector';

interface QianfanParams {
  model: string;
  size: string;
  n: number;
  prompt: string;
  negativePrompt: string;
  promptExtend: boolean;
  watermark: boolean;
  seed?: number;
  steps?: number;
  guidance?: number;
  referImage?: string;
  image?: string;
  mask?: string;
  feature?: string;
  duration?: number;
  effectScene?: string;
  useBgAudio?: boolean;
}

interface QianfanControlsProps {
  params: QianfanParams;
  onChange: (params: QianfanParams) => void;
}

export function QianfanControls({ params, onChange }: QianfanControlsProps) {
  const sizeOptions = [
    '512x512', '768x768', '1024x1024', '1280x1280', '1536x1536', '2048x2048',
    '1024x768', '2048x1536', '768x1024', '1536x2048', '1024x576', '2048x1152', '576x1024', '1152x2048'
  ];

  // 根据选择的模型显示不同的参数控件
  const renderModelSpecificControls = () => {
    if (params.model.includes('edit')) {
      return (
        <>
          <div className="control-group">
            <Label>图像编辑功能</Label>
            <select
              value={params.feature || 'repaint'}
              onChange={(e) => onChange({ ...params, feature: e.target.value })}
              className="w-full p-2 border rounded"
            >
              <option value="repaint">重绘对象</option>
              <option value="erase">消除对象</option>
              <option value="variation">生成变体</option>
            </select>
          </div>
          
          {params.feature !== 'variation' && (
            <div className="control-group">
              <Label>掩码图像URL</Label>
              <Input
                value={params.mask || ''}
                onChange={(e) => onChange({ ...params, mask: e.target.value })}
                placeholder="输入掩码图像URL"
              />
            </div>
          )}
          
          <div className="control-group">
            <Label>参考图像URL</Label>
            <Input
              value={params.image || ''}
              onChange={(e) => onChange({ ...params, image: e.target.value })}
              placeholder="输入参考图像URL"
            />
          </div>
        </>
      );
    }
    
    if (params.model.includes('musesteamer')) {
      return (
        <>
          <div className="control-group">
            <Label>视频时长(秒)</Label>
            <Slider
              value={[params.duration || 5]}
              min={5}
              max={params.model.includes('audio') ? 10 : 5}
              step={5}
              onValueChange={([duration]) => onChange({ ...params, duration })}
            />
            <div>当前时长: {params.duration || 5}秒</div>
          </div>
          
          {params.model.includes('effect') && (
            <div className="control-group">
              <Label>视频特效</Label>
              <select
                value={params.effectScene || 'squeeze'}
                onChange={(e) => onChange({ ...params, effectScene: e.target.value })}
                className="w-full p-2 border rounded"
              >
                <option value="squeeze">捏捏乐</option>
                <option value="figure_show">手办秀场</option>
                <option value="ice_cream">万物冰淇淋</option>
                <option value="expansion">膨胀气球</option>
                <option value="plush">万物毛绒</option>
                <option value="icyicy">冰爽一夏</option>
                <option value="ancient-costume">古风换装</option>
                <option value="flowers">收到花花</option>
                <option value="jellyjelly">一键果冻</option>
                <option value="papercut">剪纸世界</option>
              </select>
            </div>
          )}
          
          {params.model.includes('audio') && (
            <div className="control-group flex items-center justify-between">
              <Label>使用背景音乐</Label>
              <Switch
                checked={params.useBgAudio ?? true}
                onCheckedChange={(checked) => onChange({ ...params, useBgAudio: checked })}
              />
            </div>
          )}
        </>
      );
    }
    
    // 文生图模型的特定控件
    return (
      <div className="control-group">
        <Label>参考图像URL</Label>
        <Input
          value={params.referImage || ''}
          onChange={(e) => onChange({ ...params, referImage: e.target.value })}
          placeholder="输入参考图像URL（仅irag-1.0支持）"
        />
      </div>
    );
  };

  return (
    <div className="qianfan-controls">
      <h3>百度千帆参数设置</h3>
      
      <QianfanModelSelector 
        value={params.model} 
        onChange={(model) => onChange({ ...params, model })} 
      />
      
      <div className="control-group">
        <Label>提示词</Label>
        <Textarea
          value={params.prompt}
          onChange={(e) => onChange({ ...params, prompt: e.target.value })}
          placeholder="输入提示词"
        />
      </div>
      
      {(params.model.includes('qwen') || params.model === 'flux.1-schnell') && (
        <div className="control-group">
          <Label>反向提示词</Label>
          <Textarea
            value={params.negativePrompt}
            onChange={(e) => onChange({ ...params, negativePrompt: e.target.value })}
            placeholder="输入不希望出现的内容"
          />
        </div>
      )}
      
      <div className="control-group">
        <Label>图像分辨率</Label>
        <select
          value={params.size}
          onChange={(e) => onChange({ ...params, size: e.target.value })}
          className="w-full p-2 border rounded"
        >
          {sizeOptions.map((size) => (
            <option key={size} value={size}>{size}</option>
          ))}
        </select>
      </div>
      
      <div className="control-group">
        <Label>生成数量: {params.n}</Label>
        <Slider
          value={[params.n]}
          min={1}
          max={params.model.includes('qwen') ? 1 : 4}
          step={1}
          onValueChange={([n]) => onChange({ ...params, n })}
        />
      </div>
      
      {(params.model.includes('qwen') || params.model === 'flux.1-schnell') && (
        <>
          <div className="control-group">
            <Label>采样步数: {params.steps || (params.model === 'flux.1-schnell' ? 3.5 : 4.0)}</Label>
            <Slider
              value={[params.steps || (params.model === 'flux.1-schnell' ? 3.5 : 4.0)]}
              min={1}
              max={50}
              step={0.1}
              onValueChange={([steps]) => onChange({ ...params, steps })}
            />
          </div>
          
          <div className="control-group">
            <Label>指导密度值: {params.guidance || (params.model === 'flux.1-schnell' ? 3.5 : 4.0)}</Label>
            <Slider
              value={[params.guidance || (params.model === 'flux.1-schnell' ? 3.5 : 4.0)]}
              min={0}
              max={params.model === 'flux.1-schnell' ? 30 : 20}
              step={0.1}
              onValueChange={([guidance]) => onChange({ ...params, guidance })}
            />
          </div>
          
          <div className="control-group">
            <Label>随机种子</Label>
            <Input
              type="number"
              value={params.seed || ''}
              onChange={(e) => onChange({ ...params, seed: parseInt(e.target.value) || undefined })}
              placeholder="输入随机种子"
            />
          </div>
        </>
      )}
      
      {params.model.includes('qwen') && (
        <div className="control-group flex items-center justify-between">
          <Label>智能改写</Label>
          <Switch
            checked={params.promptExtend ?? true}
            onCheckedChange={(checked) => onChange({ ...params, promptExtend: checked })}
          />
        </div>
      )}
      
      <div className="control-group flex items-center justify-between">
        <Label>添加水印</Label>
        <Switch
          checked={params.watermark}
          onCheckedChange={(checked) => onChange({ ...params, watermark: checked })}
        />
      </div>
      
      {renderModelSpecificControls()}
    </div>
  );
}
```

## 4. 状态管理设计

### 4.1 Zustand Store 扩展
```typescript
// stores/qianfanSlice.ts
import { create } from 'zustand';
import { devtools } from 'zustand/middleware';

interface QianfanParams {
  model: string;
  size: string;
  n: number;
  prompt: string;
  negativePrompt: string;
  promptExtend: boolean;
  watermark: boolean;
  // 特定模型参数
  [key: string]: any;
}

interface QianfanState {
  prompt: string;
  qianfanParams: QianfanParams;
  isGenerating: boolean;
  generatedImages: string[];
  generatedVideo: string | null;
  taskId: string | null;
  setPrompt: (prompt: string) => void;
  setQianfanParams: (params: QianfanParams) => void;
  generateImage: () => Promise<void>;
  editImage: () => Promise<void>;
  generateVideo: () => Promise<void>;
  checkTaskStatus: () => Promise<void>;
}

export const useQianfanStore = create<QianfanState>()(
  devtools((set, get) => ({
    prompt: '',
    qianfanParams: {
      model: 'irag-1.0',
      size: '1024x1024',
      n: 1,
      prompt: '',
      negativePrompt: '',
      promptExtend: true,
      watermark: false,
    },
    isGenerating: false,
    generatedImages: [],
    generatedVideo: null,
    taskId: null,
    
    setPrompt: (prompt) => set({ prompt }),
    
    setQianfanParams: (params) => set({ qianfanParams: params }),
    
    generateImage: async () => {
      const { prompt, qianfanParams } = get();
      if (!prompt) return;
      
      set({ isGenerating: true });
      
      try {
        const result = await qianfanGenerateImage({
          prompt,
          ...qianfanParams
        });
        
        set({ 
          taskId: result.taskId || null,
          isGenerating: false 
        });
        
        // 如果有任务ID，开始轮询任务状态
        if (result.taskId) {
          const checkStatus = async () => {
            const status = await getQianfanTaskStatus(result.taskId!);
            if (status.taskStatus === 'SUCCEEDED' && status.results) {
              const imageUrls = status.results.map(r => r.url);
              set({ generatedImages: imageUrls });
            } else if (status.taskStatus === 'FAILED') {
              throw new Error('图像生成失败');
            } else {
              // 继续轮询
              setTimeout(checkStatus, 5000);
            }
          };
          
          setTimeout(checkStatus, 5000);
        } else if (result.imageUrls) {
          // 如果直接返回了图像URLs
          set({ generatedImages: result.imageUrls });
        }
      } catch (error) {
        set({ isGenerating: false });
        throw error;
      }
    },
    
    editImage: async () => {
      const { prompt, qianfanParams } = get();
      if (!prompt) return;
      
      set({ isGenerating: true });
      
      try {
        const result = await qianfanEditImage({
          prompt,
          ...qianfanParams
        });
        
        set({ 
          taskId: result.taskId || null,
          isGenerating: false 
        });
        
        // 如果有任务ID，开始轮询任务状态
        if (result.taskId) {
          const checkStatus = async () => {
            const status = await getQianfanTaskStatus(result.taskId!);
            if (status.taskStatus === 'SUCCEEDED' && status.results) {
              const imageUrls = status.results.map(r => r.url);
              set({ generatedImages: imageUrls });
            } else if (status.taskStatus === 'FAILED') {
              throw new Error('图像编辑失败');
            } else {
              // 继续轮询
              setTimeout(checkStatus, 5000);
            }
          };
          
          setTimeout(checkStatus, 5000);
        } else if (result.imageUrls) {
          // 如果直接返回了图像URLs
          set({ generatedImages: result.imageUrls });
        }
      } catch (error) {
        set({ isGenerating: false });
        throw error;
      }
    },
    
    generateVideo: async () => {
      const { prompt, qianfanParams } = get();
      if (!prompt) return;
      
      set({ isGenerating: true });
      
      try {
        const result = await qianfanGenerateVideo({
          prompt,
          ...qianfanParams
        });
        
        set({ 
          taskId: result.taskId || null,
          isGenerating: false 
        });
        
        // 如果有任务ID，开始轮询任务状态
        if (result.taskId) {
          const checkStatus = async () => {
            const status = await getQianfanTaskStatus(result.taskId!);
            if (status.taskStatus === 'SUCCEEDED' && status.results) {
              const videoUrls = status.results.map(r => r.url);
              set({ generatedVideo: videoUrls[0] || null });
            } else if (status.taskStatus === 'FAILED') {
              throw new Error('视频生成失败');
            } else {
              // 继续轮询
              setTimeout(checkStatus, 5000);
            }
          };
          
          setTimeout(checkStatus, 5000);
        } else if (result.videoUrl) {
          // 如果直接返回了视频URL
          set({ generatedVideo: result.videoUrl });
        }
      } catch (error) {
        set({ isGenerating: false });
        throw error;
      }
    },
    
    checkTaskStatus: async () => {
      const { taskId } = get();
      if (!taskId) return;
      
      try {
        const status = await getQianfanTaskStatus(taskId);
        if (status.taskStatus === 'SUCCEEDED' && status.results) {
          const imageUrls = status.results.map(r => r.url);
          set({ generatedImages: imageUrls });
        }
      } catch (error) {
        throw error;
      }
    }
  }))
);
```

## 5. UI/UX 设计

### 5.1 界面布局
```
+-----------------------------------------------------+
| 百度千帆图像处理                                     |
+----------------------+-----------------------------+
| 控制面板             | 预览区域                    |
|                      |                             |
| [选择模型 ▼]         | [提示词输入框]              |
| [分辨率: 1024x1024]  |                             |
| [生成数量: 1 ----o]  | [生成按钮]                  |
| [反向提示词输入框]   |                             |
| [√] 智能改写         | [生成中的图像占位符]        |
| [ ] 添加水印         |                             |
| [特定模型参数控件]    |                             |
|                      |                             |
+----------------------+-----------------------------+
```

### 5.2 交互流程
1. 用户选择百度千帆模型
2. 用户输入提示词和反向提示词
3. 用户调整参数设置
4. 点击"生成图像/编辑图像/生成视频"按钮
5. 显示任务提交状态和轮询进度
6. 任务完成后展示生成的图像或视频
7. 提供下载和继续编辑选项

## 6. 开发计划

### 6.1 第一阶段：基础框架搭建 (1周)
- [ ] 创建组件结构和文件
- [ ] 实现 Zustand 状态管理
- [ ] 设计 UI 组件
- [ ] 实现基础 API 调用

### 6.2 第二阶段：核心功能开发 (2周)
- [ ] 实现文生图功能
- [ ] 实现图像编辑功能
- [ ] 实现任务状态轮询机制
- [ ] 实现参数配置功能

### 6.3 第三阶段：视频功能开发 (1周)
- [ ] 实现视频生成功能
- [ ] 实现视频特效参数配置
- [ ] 实现视频任务状态查询

### 6.4 第四阶段：增强功能开发 (1周)
- [ ] 实现反向提示词功能
- [ ] 添加智能改写选项
- [ ] 实现水印功能
- [ ] 优化用户界面

### 6.5 第五阶段：测试与优化 (1周)
- [ ] 功能测试
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 文档完善

## 7. 测试方案

### 7.1 单元测试
- 测试状态管理功能
- 测试参数验证逻辑
- 测试API调用函数

### 7.2 集成测试
- 测试完整的图像处理流程
- 测试不同模型的兼容性
- 测试边界条件处理

### 7.3 用户验收测试
- 邀请用户测试生成效果
- 收集用户反馈
- 优化用户体验

## 8. 部署与维护

### 8.1 部署要求
- 确保百度千帆API密钥配置正确
- 验证图像生成和下载功能
- 测试不同浏览器兼容性

### 8.2 维护计划
- 定期更新支持的模型列表
- 监控API调用情况
- 收集用户反馈并持续优化

## 9. 风险评估与应对

### 9.1 技术风险
- **API稳定性**: 依赖百度千帆API可能存在不稳定因素
  - 应对措施: 实现错误重试机制和降级方案

- **处理性能问题**: 图像处理可能需要较长时间
  - 应对措施: 实现进度指示和后台处理能力

### 9.2 用户体验风险
- **生成时间过长**: AI处理可能需要数分钟
  - 应对措施: 提供进度指示和任务状态查询

## 10. 百度千帆API集成细节

### 10.1 认证方式
百度千帆API使用API Key进行身份认证，需要在请求头中添加:
```
Authorization: Bearer YOUR_API_KEY
```

### 10.2 请求地址
- 图像生成: `https://qianfan.baidubce.com/v2/images/generations`
- 图像编辑: `https://qianfan.baidubce.com/v2/images/edits`
- 视频生成: `https://qianfan.baidubce.com/video/generations`

### 10.3 任务状态查询
视频生成任务创建后需要通过任务ID轮询查询状态:
- 查询视频生成任务: `https://qianfan.baidubce.com/video/generations/{task_id}`

### 10.4 支持的模型
1. `irag-1.0` - IRAG 1.0文生图模型
2. `flux.1-schnell` - Flux.1 Schnell文生图模型
3. `qwen-image` - Qwen Image文生图模型
4. `ernie-irag-edit` - Ernie Irag Edit图像编辑模型
5. `qwen-image-edit` - Qwen Image Edit图像编辑模型
6. `musesteamer-2.0-turbo-i2v-audio` - MuseSteamer 2.0 Turbo I2V Audio视频生成模型
7. `musesteamer-2.0-turbo-i2v` - MuseSteamer 2.0 Turbo I2V视频生成模型
8. `musesteamer-2.0-lite-i2v` - MuseSteamer 2.0 Lite I2V视频生成模型
9. `musesteamer-2.0-pro-i2v` - MuseSteamer 2.0 Pro I2V视频生成模型
10. `musesteamer-2.0-turbo-i2v-effect` - MuseSteamer 2.0 Turbo I2V Effect视频生成模型