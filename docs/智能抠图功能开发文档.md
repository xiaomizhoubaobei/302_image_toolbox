# 智能抠图功能开发文档

## 1. 功能概述

### 1.1 功能名称
智能抠图 (Smart Object Removal)

### 1.2 功能描述
智能抠图功能利用先进的AI技术，能够精确识别图片中的主体对象并将其从背景中分离出来。该功能支持自动识别和手动调整，提供高质量的抠图结果，适用于各种复杂场景。

### 1.3 目标用户
- 电商产品摄影师
- 平面设计师
- 社交媒体内容创作者
- 需要精确抠图的普通用户

## 2. 功能需求

### 2.1 核心功能
1. **自动主体识别**：AI自动识别图片中的主要对象
2. **精细边缘处理**：处理毛发、透明物体等复杂边缘
3. **手动调整工具**：提供画笔工具进行精细调整
4. **背景替换**：支持透明背景或自定义背景
5. **批量处理**：支持多张图片同时处理

### 2.2 用户界面需求
1. 图片上传区域
2. 自动识别按钮
3. 手动调整画笔工具
4. 背景选择面板
5. 实时预览窗口
6. 处理进度显示

## 3. 技术实现方案

### 3.1 技术架构
```
前端组件层:
- SmartMatting.tsx (主组件)
- MattingCanvas.tsx (抠图画布)
- MattingTools.tsx (工具面板)
- BackgroundSelector.tsx (背景选择器)
- MattingPreview.tsx (预览组件)

状态管理层:
- Zustand store (扩展现有状态)
- mattingSlice.ts (抠图功能状态)

API层:
- lib/api.ts (新增抠图API调用)
- utils/Matting.ts (抠图处理工具)

类型定义层:
- types/index.ts (新增类型定义)
```

### 3.2 API接口设计
```typescript
// 智能抠图API接口
interface SmartMattingAction {
  imageSrc: string;
  mode: 'auto' | 'manual' | 'refine';
  mask?: string; // 手动标记的遮罩
  refineMask?: string; // 精细调整遮罩
  backgroundColor?: string; // 背景颜色
  backgroundSrc?: string; // 背景图片
  outputFormat?: 'png' | 'jpg' | 'webp';
}

interface SmartMattingResult {
  imageSrc: string;
  maskSrc: string; // 生成的遮罩图像
  processingTime: number; // 处理时间(ms)
  accuracy: number; // 抠图准确度(0-100)
}

// 主要API函数
export async function smartMatting(action: SmartMattingAction): Promise<SmartMattingResult> {
  // 实现智能抠图逻辑
}
```

### 3.3 组件设计

#### 3.3.1 主组件 SmartMatting.tsx
```tsx
import React from 'react';
import { MattingCanvas } from './MattingCanvas';
import { MattingTools } from './MattingTools';
import { BackgroundSelector } from './BackgroundSelector';
import { MattingPreview } from './MattingPreview';
import { useMattingStore } from '@/stores/mattingSlice';

export function SmartMatting() {
  const { 
    originalImage, 
    mattingResult, 
    mattingParams,
    mask,
    setMattingParams,
    smartMatting,
    isProcessing
  } = useMattingStore();

  return (
    <div className="smart-matting-container">
      <div className="matting-header">
        <h2>智能抠图</h2>
        <p>精确识别并分离图片中的主体对象</p>
      </div>
      
      <div className="matting-content">
        <div className="matting-sidebar">
          <MattingTools 
            params={mattingParams}
            onChange={setMattingParams}
            onProcess={smartMatting}
            isProcessing={isProcessing}
          />
          
          <BackgroundSelector 
            selectedBackground={mattingParams.backgroundSrc}
            onSelectBackground={(background) => setMattingParams({ ...mattingParams, backgroundSrc: background })}
          />
        </div>
        
        <div className="matting-main">
          <MattingCanvas 
            image={originalImage}
            mask={mask}
            result={mattingResult}
            isProcessing={isProcessing}
          />
        </div>
        
        <div className="matting-preview">
          <MattingPreview 
            original={originalImage}
            result={mattingResult}
          />
        </div>
      </div>
    </div>
  );
}
```

#### 3.3.2 抠图画布 MattingCanvas.tsx
```tsx
import React from 'react';
import { Stage, Layer, Image } from 'react-konva';

interface MattingCanvasProps {
  image: string | null;
  mask: string | null;
  result: string | null;
  isProcessing: boolean;
}

export function MattingCanvas({ image, mask, result, isProcessing }: MattingCanvasProps) {
  return (
    <div className="matting-canvas">
      {isProcessing ? (
        <div className="processing-overlay">
          <div className="spinner"></div>
          <p>正在智能抠图...</p>
        </div>
      ) : result ? (
        <div className="matting-result">
          <img src={result} alt="抠图结果" />
        </div>
      ) : (
        <Stage width={800} height={600} className="matting-stage">
          <Layer>
            {image && (
              <Image
                image={image}
                x={0}
                y={0}
                width={800}
                height={600}
              />
            )}
            {mask && (
              <Image
                image={mask}
                x={0}
                y={0}
                width={800}
                height={600}
                opacity={0.5}
              />
            )}
          </Layer>
        </Stage>
      )}
    </div>
  );
}
```

## 4. 状态管理设计

### 4.1 Zustand Store 扩展
```typescript
// stores/mattingSlice.ts
import { create } from 'zustand';
import { devtools } from 'zustand/middleware';

interface MattingParams {
  mode: 'auto' | 'manual' | 'refine';
  backgroundColor?: string;
  backgroundSrc?: string;
  outputFormat: 'png' | 'jpg' | 'webp';
}

interface MattingState {
  originalImage: string | null;
  mattingResult: string | null;
  mask: string | null;
  mattingParams: MattingParams;
  isProcessing: boolean;
  setOriginalImage: (image: string) => void;
  setMattingParams: (params: MattingParams) => void;
  smartMatting: () => Promise<void>;
}

export const useMattingStore = create<MattingState>()(
  devtools((set, get) => ({
    originalImage: null,
    mattingResult: null,
    mask: null,
    mattingParams: {
      mode: 'auto',
      outputFormat: 'png'
    },
    isProcessing: false,
    
    setOriginalImage: (image) => set({ originalImage: image }),
    
    setMattingParams: (params) => set({ mattingParams: params }),
    
    smartMatting: async () => {
      const { originalImage, mattingParams } = get();
      if (!originalImage) return;
      
      set({ isProcessing: true });
      
      try {
        const result = await smartMatting({
          imageSrc: originalImage,
          ...mattingParams
        });
        
        set({ 
          mattingResult: result.imageSrc,
          mask: result.maskSrc,
          isProcessing: false 
        });
      } catch (error) {
        set({ isProcessing: false });
        throw error;
      }
    }
  }))
);
```

## 5. UI/UX 设计

### 5.1 界面布局
```
+---------------------------------------------------------------+
| 智能抠图工具                                                  |
+-----------+----------------------+---------------------------+
| 工具面板  | 抠图画布             | 预览区域                  |
|           |                      |                           |
| [自动识别] | [抠图编辑区域]       | [原始图片] [抠图结果]    |
| [手动调整] |                      |                           |
| [精细处理] |                      |                           |
|           |                      |                           |
| 背景设置  |                      |                           |
| [透明背景] |                      |                           |
| [纯色背景] |                      |                           |
| [图片背景] |                      |                           |
+-----------+----------------------+---------------------------+
| [上传图片] [开始抠图] [下载结果]                              |
+---------------------------------------------------------------+
```

### 5.2 交互流程
1. 用户上传需要抠图的图片
2. 点击"自动识别"按钮进行主体识别
3. 使用手动调整工具优化抠图边缘
4. 选择背景设置（透明/纯色/图片）
5. 实时预览抠图效果
6. 点击"开始抠图"按钮
7. 显示处理进度
8. 展示抠图后的图片
9. 提供下载和继续编辑选项

## 6. 开发计划

### 6.1 第一阶段：基础框架搭建 (1周)
- [ ] 创建组件结构和文件
- [ ] 实现 Zustand 状态管理
- [ ] 设计 UI 组件
- [ ] 实现图片上传功能

### 6.2 第二阶段：核心功能开发 (2周)
- [ ] 实现自动主体识别功能
- [ ] 实现基础抠图算法
- [ ] 实现透明背景输出
- [ ] 实现基本的画布操作

### 6.3 第三阶段：增强功能开发 (1周)
- [ ] 实现手动调整工具
- [ ] 实现背景替换功能
- [ ] 添加批量处理功能
- [ ] 优化处理性能

### 6.4 第四阶段：测试与优化 (1周)
- [ ] 功能测试
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 文档完善

## 7. 测试方案

### 7.1 单元测试
- 测试状态管理功能
- 测试参数验证逻辑
- 测试图像处理函数

### 7.2 集成测试
- 测试完整的抠图流程
- 测试不同背景设置的效果
- 测试批量处理功能

### 7.3 用户验收测试
- 邀请设计师测试抠图效果
- 收集用户反馈
- 优化用户体验

## 8. 部署与维护

### 8.1 部署要求
- 确保302.AI API密钥配置正确
- 验证图像上传和处理功能
- 测试不同浏览器兼容性

### 8.2 维护计划
- 定期更新AI模型
- 监控API调用情况
- 收集用户反馈并持续优化