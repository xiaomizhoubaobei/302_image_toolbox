# 阿里百炼模型集成开发文档

## 1. 功能概述

### 1.1 功能名称
阿里百炼模型集成 (Aliyun Bailian Model Integration)

### 1.2 功能描述
阿里百炼模型集成功能旨在将阿里云百炼平台的通义万相图像生成模型集成到302.AI图片工具箱中，为用户提供更多样化的AI图像生成选项。通义万相支持高质量的文生图功能，具有多种艺术风格和写实摄影效果。

### 1.3 目标用户
- 需要多样化图像生成风格的用户
- 对通义万相模型有特定需求的设计师和内容创作者
- 希望在统一平台使用多种AI模型的开发者

## 2. 功能需求

### 2.1 核心功能
1. **文生图功能**：支持通过文本描述生成图像
2. **多模型支持**：集成通义万相多个版本模型（wan2.5-t2i-preview, wan2.2-t2i-flash等）
3. **参数配置**：支持图像分辨率、生成数量等参数配置
4. **反向提示词**：支持negative_prompt参数，排除不希望出现的内容
5. **智能改写**：支持prompt智能改写功能

### 2.2 用户界面需求
1. 模型选择下拉菜单
2. 图像分辨率设置控件
3. 生成数量调节器
4. 反向提示词输入框
5. 智能改写开关
6. 水印添加选项

## 3. 技术实现方案

### 3.1 技术架构
```
前端组件层:
- BailianModelSelector.tsx (模型选择组件)
- BailianControls.tsx (参数控制面板)
- BailianImageGenerator.tsx (图像生成主组件)

状态管理层:
- Zustand store (扩展全局状态)
- bailianSlice.ts (阿里百炼功能状态)

API层:
- lib/api.ts (新增阿里百炼API调用)
- utils/Bailian.ts (阿里百炼工具函数)

类型定义层:
- types/index.ts (新增类型定义)
```

### 3.2 API接口设计
```typescript
// 阿里百炼文生图API接口
interface BailianTextToImageAction {
  prompt: string;
  negativePrompt?: string;
  model: string; // 模型名称，如 'wan2.5-t2i-preview'
  size: string; // 图像分辨率，如 '1024*1024'
  n: number; // 生成图片数量，1-4
  promptExtend?: boolean; // 是否开启prompt智能改写
  watermark?: boolean; // 是否添加水印
  seed?: number; // 随机数种子
}

interface BailianTextToImageResult {
  imageUrls: string[]; // 生成的图像URL列表
  taskId: string; // 任务ID
  processingTime: number; // 处理时间(ms)
  actualPrompt?: string; // 实际使用的提示词（开启智能改写时）
}

// 主要API函数
export async function bailianTextToImage(action: BailianTextToImageAction): Promise<BailianTextToImageResult> {
  // 实现阿里百炼文生图逻辑
}

// 任务状态查询API
interface BailianTaskStatus {
  taskId: string;
  taskStatus: 'PENDING' | 'RUNNING' | 'SUCCEEDED' | 'FAILED' | 'CANCELED' | 'UNKNOWN';
  results?: Array<{ url: string }>;
}

export async function getBailianTaskStatus(taskId: string): Promise<BailianTaskStatus> {
  // 查询阿里百炼任务状态
}
```

### 3.3 组件设计

#### 3.3.1 模型选择组件 BailianModelSelector.tsx
```tsx
import React from 'react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';

interface BailianModelSelectorProps {
  value: string;
  onChange: (model: string) => void;
}

export function BailianModelSelector({ value, onChange }: BailianModelSelectorProps) {
  const models = [
    { name: '万相2.5 Preview', value: 'wan2.5-t2i-preview' },
    { name: '万相2.2 极速版', value: 'wan2.2-t2i-flash' },
    { name: '万相2.2 专业版', value: 'wan2.2-t2i-plus' },
    { name: '万相2.1 极速版', value: 'wanx2.1-t2i-turbo' },
    { name: '万相2.1 专业版', value: 'wanx2.1-t2i-plus' },
  ];

  return (
    <div className="bailian-model-selector">
      <label>选择模型</label>
      <Select value={value} onValueChange={onChange}>
        <SelectTrigger>
          <SelectValue placeholder="选择阿里百炼模型" />
        </SelectTrigger>
        <SelectContent>
          {models.map((model) => (
            <SelectItem key={model.value} value={model.value}>
              {model.name}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>
    </div>
  );
}
```

#### 3.3.2 参数控制面板 BailianControls.tsx
```tsx
import React from 'react';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Slider } from '@/components/ui/slider';
import { Switch } from '@/components/ui/switch';
import { BailianModelSelector } from './BailianModelSelector';

interface BailianParams {
  model: string;
  size: string;
  n: number;
  negativePrompt: string;
  promptExtend: boolean;
  watermark: boolean;
}

interface BailianControlsProps {
  params: BailianParams;
  onChange: (params: BailianParams) => void;
}

export function BailianControls({ params, onChange }: BailianControlsProps) {
  const sizeOptions = [
    '512*512', '768*768', '1024*1024', '1280*1280',
    '800*1200', '1200*800', '960*1280', '1280*960'
  ];

  return (
    <div className="bailian-controls">
      <h3>阿里百炼参数设置</h3>
      
      <BailianModelSelector 
        value={params.model} 
        onChange={(model) => onChange({ ...params, model })} 
      />
      
      <div className="control-group">
        <Label>图像分辨率</Label>
        <select
          value={params.size}
          onChange={(e) => onChange({ ...params, size: e.target.value })}
          className="w-full p-2 border rounded"
        >
          {sizeOptions.map((size) => (
            <option key={size} value={size}>{size}</option>
          ))}
        </select>
      </div>
      
      <div className="control-group">
        <Label>生成数量: {params.n}</Label>
        <Slider
          value={[params.n]}
          min={1}
          max={4}
          step={1}
          onValueChange={([n]) => onChange({ ...params, n })}
        />
      </div>
      
      <div className="control-group">
        <Label>反向提示词</Label>
        <Input
          value={params.negativePrompt}
          onChange={(e) => onChange({ ...params, negativePrompt: e.target.value })}
          placeholder="输入不希望出现的内容"
        />
      </div>
      
      <div className="control-group flex items-center justify-between">
        <Label>智能改写</Label>
        <Switch
          checked={params.promptExtend}
          onCheckedChange={(checked) => onChange({ ...params, promptExtend: checked })}
        />
      </div>
      
      <div className="control-group flex items-center justify-between">
        <Label>添加水印</Label>
        <Switch
          checked={params.watermark}
          onCheckedChange={(checked) => onChange({ ...params, watermark: checked })}
        />
      </div>
    </div>
  );
}
```

## 4. 状态管理设计

### 4.1 Zustand Store 扩展
```typescript
// stores/bailianSlice.ts
import { create } from 'zustand';
import { devtools } from 'zustand/middleware';

interface BailianParams {
  model: string;
  size: string;
  n: number;
  negativePrompt: string;
  promptExtend: boolean;
  watermark: boolean;
}

interface BailianState {
  prompt: string;
  bailianParams: BailianParams;
  isGenerating: boolean;
  generatedImages: string[];
  taskId: string | null;
  setPrompt: (prompt: string) => void;
  setBailianParams: (params: BailianParams) => void;
  generateImage: () => Promise<void>;
  checkTaskStatus: () => Promise<void>;
}

export const useBailianStore = create<BailianState>()(
  devtools((set, get) => ({
    prompt: '',
    bailianParams: {
      model: 'wan2.5-t2i-preview',
      size: '1024*1024',
      n: 1,
      negativePrompt: '',
      promptExtend: false,
      watermark: false,
    },
    isGenerating: false,
    generatedImages: [],
    taskId: null,
    
    setPrompt: (prompt) => set({ prompt }),
    
    setBailianParams: (params) => set({ bailianParams: params }),
    
    generateImage: async () => {
      const { prompt, bailianParams } = get();
      if (!prompt) return;
      
      set({ isGenerating: true });
      
      try {
        const result = await bailianTextToImage({
          prompt,
          ...bailianParams
        });
        
        set({ 
          taskId: result.taskId,
          isGenerating: false 
        });
        
        // 开始轮询任务状态
        const checkStatus = async () => {
          const status = await getBailianTaskStatus(result.taskId);
          if (status.taskStatus === 'SUCCEEDED' && status.results) {
            const imageUrls = status.results.map(r => r.url);
            set({ generatedImages: imageUrls });
          } else if (status.taskStatus === 'FAILED') {
            throw new Error('图像生成失败');
          } else {
            // 继续轮询
            setTimeout(checkStatus, 5000);
          }
        };
        
        setTimeout(checkStatus, 5000);
      } catch (error) {
        set({ isGenerating: false });
        throw error;
      }
    },
    
    checkTaskStatus: async () => {
      const { taskId } = get();
      if (!taskId) return;
      
      try {
        const status = await getBailianTaskStatus(taskId);
        if (status.taskStatus === 'SUCCEEDED' && status.results) {
          const imageUrls = status.results.map(r => r.url);
          set({ generatedImages: imageUrls });
        }
      } catch (error) {
        throw error;
      }
    }
  }))
);
```

## 5. UI/UX 设计

### 5.1 界面布局
```
+-----------------------------------------------------+
| 阿里百炼图像生成                                   |
+----------------------+-----------------------------+
| 控制面板             | 预览区域                    |
|                      |                             |
| [选择模型 ▼]         | [提示词输入框]              |
| [分辨率: 1024*1024]  |                             |
| [生成数量: 1 ----o]  | [生成按钮]                  |
| [反向提示词输入框]   |                             |
| [√] 智能改写         | [生成中的图像占位符]        |
| [ ] 添加水印         |                             |
|                      |                             |
+----------------------+-----------------------------+
```

### 5.2 交互流程
1. 用户选择阿里百炼模型
2. 用户输入提示词
3. 用户调整参数设置
4. 点击"生成图像"按钮
5. 显示任务提交状态和轮询进度
6. 任务完成后展示生成的图像
7. 提供下载和继续编辑选项

## 6. 开发计划

### 6.1 第一阶段：基础框架搭建 (1周)
- [ ] 创建组件结构和文件
- [ ] 实现 Zustand 状态管理
- [ ] 设计 UI 组件
- [ ] 实现基础 API 调用

### 6.2 第二阶段：核心功能开发 (2周)
- [ ] 实现文生图功能
- [ ] 实现任务状态轮询机制
- [ ] 实现参数配置功能
- [ ] 添加错误处理机制

### 6.3 第三阶段：增强功能开发 (1周)
- [ ] 实现反向提示词功能
- [ ] 添加智能改写选项
- [ ] 实现水印功能
- [ ] 优化用户界面

### 6.4 第四阶段：测试与优化 (1周)
- [ ] 功能测试
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 文档完善

## 7. 测试方案

### 7.1 单元测试
- 测试状态管理功能
- 测试参数验证逻辑
- 测试API调用函数

### 7.2 集成测试
- 测试完整的图像生成流程
- 测试不同模型的兼容性
- 测试边界条件处理

### 7.3 用户验收测试
- 邀请用户测试生成效果
- 收集用户反馈
- 优化用户体验

## 8. 部署与维护

### 8.1 部署要求
- 确保阿里云API密钥配置正确
- 验证图像生成和下载功能
- 测试不同浏览器兼容性

### 8.2 维护计划
- 定期更新支持的模型列表
- 监控API调用情况
- 收集用户反馈并持续优化

## 9. 风险评估与应对

### 9.1 技术风险
- **API稳定性**: 依赖阿里云API可能存在不稳定因素
  - 应对措施: 实现错误重试机制和降级方案

- **处理性能问题**: 图像生成可能需要较长时间
  - 应对措施: 实现进度指示和后台处理能力

### 9.2 用户体验风险
- **生成时间过长**: AI处理可能需要数分钟
  - 应对措施: 提供进度指示和任务状态查询

## 10. 阿里百炼API集成细节

### 10.1 认证方式
阿里百炼API使用API Key进行身份认证，需要在请求头中添加:
```
Authorization: Bearer YOUR_API_KEY
X-DashScope-Async: enable
```

### 10.2 请求地址
- 北京地域: `https://dashscope.aliyuncs.com/api/v1/services/aigc/text2image/image-synthesis`
- 新加坡地域: `https://dashscope-intl.aliyuncs.com/api/v1/services/aigc/text2image/image-synthesis`

### 10.3 任务状态查询
任务创建后需要通过任务ID轮询查询状态:
- 北京地域: `https://dashscope.aliyuncs.com/api/v1/tasks/{task_id}`
- 新加坡地域: `https://dashscope-intl.aliyuncs.com/api/v1/tasks/{task_id}`

### 10.4 支持的模型
1. `wan2.5-t2i-preview` - 万相2.5 preview版本
2. `wan2.2-t2i-flash` - 万相2.2极速版
3. `wan2.2-t2i-plus` - 万相2.2专业版
4. `wanx2.1-t2i-turbo` - 万相2.1极速版
5. `wanx2.1-t2i-plus` - 万相2.1专业版