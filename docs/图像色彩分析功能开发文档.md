# 图像色彩分析功能开发文档

## 1. 功能概述

### 1.1 功能名称
图像色彩分析 (Image Color Analysis)

### 1.2 功能描述
图像色彩分析功能利用计算机视觉技术分析图片的色彩构成，提取主要颜色、色彩分布、色调特征等信息。该功能可帮助用户了解图片的色彩特点，为设计、调色、配色等提供数据支持。

### 1.3 目标用户
- 平面设计师和视觉艺术家
- 摄影师
- UI/UX设计师
- 色彩研究人员
- 需要色彩分析的普通用户

## 2. 功能需求

### 2.1 核心功能
1. **主色调提取**：识别图片中的主要颜色
2. **色彩分布分析**：分析图片中各种颜色的占比
3. **色调特征识别**：识别图片的整体色调倾向（冷暖色调等）
4. **色彩和谐度分析**：分析图片色彩的和谐程度
5. **调色建议**：根据分析结果提供调色建议
6. **调色板生成**：生成可使用的色彩调色板

### 2.2 用户界面需求
1. 图片上传区域
2. 色彩分析结果显示区域
3. 主要颜色展示面板
4. 色彩分布图表
5. 色调特征指示器
6. 调色建议面板
7. 调色板导出功能

## 3. 技术实现方案

### 3.1 技术架构
```
前端组件层:
- ColorAnalyzer.tsx (主组件)
- MainColorsDisplay.tsx (主要颜色展示组件)
- ColorDistributionChart.tsx (色彩分布图表)
- ToneIndicator.tsx (色调特征指示器)
- ColorPalette.tsx (调色板组件)
- AdjustmentSuggestions.tsx (调色建议组件)

状态管理层:
- Zustand store (扩展现有状态)
- colorSlice.ts (色彩分析功能状态)

API层:
- lib/api.ts (新增色彩分析API调用)
- utils/ColorAnalysis.ts (色彩分析工具)

类型定义层:
- types/index.ts (新增类型定义)
```

### 3.2 API接口设计
```typescript
// 图像色彩分析API接口
interface ColorAnalysisAction {
  imageSrc: string;
  analysisDepth: 'basic' | 'standard' | 'detailed';
  colorCount: number; // 提取的主要颜色数量 1-20
  includePalette: boolean;
  includeHarmony: boolean;
  outputFormat: 'json' | 'csv' | 'palette';
}

interface ColorInfo {
  hex: string;
  rgb: { r: number; g: number; b: number };
  hsl: { h: number; s: number; l: number };
  name: string;
  percentage: number;
}

interface ColorAnalysisResult {
  mainColors: ColorInfo[];
  colorDistribution: Array<{
    color: ColorInfo;
    count: number;
    percentage: number;
  }>;
  tone: {
    type: 'warm' | 'cool' | 'neutral';
    intensity: number; // 0-100
  };
  harmony: {
    score: number; // 0-100
    type: 'monochromatic' | 'analogous' | 'complementary' | 'triadic' | 'tetradic' | 'complex';
  };
  palette: {
    primary: ColorInfo;
    secondary: ColorInfo;
    accent: ColorInfo;
    background: ColorInfo;
    text: ColorInfo;
  };
  statistics: {
    brightness: number; // 0-100
    saturation: number; // 0-100
    contrast: number; // 0-100
  };
  processingTime: number; // 处理时间(ms)
}

// 主要API函数
export async function analyzeImageColors(action: ColorAnalysisAction): Promise<ColorAnalysisResult> {
  // 实现图像色彩分析逻辑
}
```

### 3.3 组件设计

#### 3.3.1 主组件 ColorAnalyzer.tsx
```tsx
import React from 'react';
import { MainColorsDisplay } from './MainColorsDisplay';
import { ColorDistributionChart } from './ColorDistributionChart';
import { ToneIndicator } from './ToneIndicator';
import { ColorPalette } from './ColorPalette';
import { AdjustmentSuggestions } from './AdjustmentSuggestions';
import { useColorStore } from '@/stores/colorSlice';

export function ColorAnalyzer() {
  const { 
    originalImage, 
    colorAnalysisResult, 
    colorParams,
    setColorParams,
    analyzeImageColors,
    isProcessing
  } = useColorStore();

  return (
    <div className="color-analyzer-container">
      <div className="analyzer-header">
        <h2>图像色彩分析</h2>
        <p>分析图片色彩构成，提取主要颜色和调色板</p>
      </div>
      
      <div className="analyzer-content">
        <div className="analyzer-sidebar">
          <div className="analysis-controls">
            <h3>分析设置</h3>
            <div className="control-group">
              <label>分析深度</label>
              <select
                value={colorParams.analysisDepth}
                onChange={(e) => setColorParams({ 
                  ...colorParams, 
                  analysisDepth: e.target.value as any 
                })}
              >
                <option value="basic">基础</option>
                <option value="standard">标准</option>
                <option value="detailed">详细</option>
              </select>
            </div>
            
            <div className="control-group">
              <label>主要颜色数量: {colorParams.colorCount}</label>
              <input
                type="range"
                min="1"
                max="20"
                value={colorParams.colorCount}
                onChange={(e) => setColorParams({ 
                  ...colorParams, 
                  colorCount: parseInt(e.target.value) 
                })}
              />
            </div>
            
            <div className="option-controls">
              <label className="checkbox-label">
                <input
                  type="checkbox"
                  checked={colorParams.includePalette}
                  onChange={(e) => setColorParams({ 
                    ...colorParams, 
                    includePalette: e.target.checked 
                  })}
                />
                生成调色板
              </label>
              
              <label className="checkbox-label">
                <input
                  type="checkbox"
                  checked={colorParams.includeHarmony}
                  onChange={(e) => setColorParams({ 
                    ...colorParams, 
                    includeHarmony: e.target.checked 
                  })}
                />
                色彩和谐分析
              </label>
            </div>
          </div>
          
          {colorAnalysisResult && (
            <ColorPalette 
              palette={colorAnalysisResult.palette}
              onExport={() => {
                // 导出调色板逻辑
              }}
            />
          )}
        </div>
        
        <div className="analyzer-main">
          <div className="image-preview">
            {originalImage && (
              <img src={originalImage} alt="待分析图片" />
            )}
          </div>
          
          {colorAnalysisResult && !isProcessing && (
            <div className="analysis-results">
              <MainColorsDisplay 
                colors={colorAnalysisResult.mainColors}
              />
              
              <ColorDistributionChart 
                distribution={colorAnalysisResult.colorDistribution}
              />
              
              <div className="analysis-summary">
                <ToneIndicator 
                  tone={colorAnalysisResult.tone}
                />
                
                {colorParams.includeHarmony && (
                  <div className="harmony-score">
                    <h3>色彩和谐度</h3>
                    <div className="score-bar">
                      <div 
                        className="score-fill"
                        style={{ width: `${colorAnalysisResult.harmony.score}%` }}
                      ></div>
                      <span className="score-text">
                        {colorAnalysisResult.harmony.score}%
                      </span>
                    </div>
                    <p>类型: {colorAnalysisResult.harmony.type}</p>
                  </div>
                )}
              </div>
              
              <AdjustmentSuggestions 
                statistics={colorAnalysisResult.statistics}
                harmony={colorAnalysisResult.harmony}
              />
            </div>
          )}
          
          {isProcessing && (
            <div className="processing-indicator">
              <div className="spinner"></div>
              <p>正在分析图片色彩...</p>
            </div>
          )}
        </div>
      </div>
      
      <div className="analyzer-footer">
        <button 
          className="analyze-button"
          disabled={!originalImage || isProcessing}
          onClick={analyzeImageColors}
        >
          {isProcessing ? '分析中...' : '开始分析'}
        </button>
        
        {colorAnalysisResult && (
          <div className="action-buttons">
            <button className="export-button" onClick={() => {
              // 导出分析结果逻辑
            }}>
              导出分析结果
            </button>
            
            <button className="copy-button" onClick={() => {
              // 复制调色板逻辑
            }}>
              复制调色板
            </button>
          </div>
        )}
      </div>
    </div>
  );
}
```

#### 3.3.2 主要颜色展示组件 MainColorsDisplay.tsx
```tsx
import React from 'react';
import { ColorInfo } from '@/types';

interface MainColorsDisplayProps {
  colors: ColorInfo[];
}

export function MainColorsDisplay({ colors }: MainColorsDisplayProps) {
  return (
    <div className="main-colors-display">
      <h3>主要颜色</h3>
      <div className="colors-grid">
        {colors.map((color, index) => (
          <div key={index} className="color-item">
            <div 
              className="color-swatch"
              style={{ backgroundColor: color.hex }}
            ></div>
            <div className="color-info">
              <div className="color-name">{color.name}</div>
              <div className="color-hex">{color.hex}</div>
              <div className="color-percentage">{color.percentage.toFixed(1)}%</div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
```

## 4. 状态管理设计

### 4.1 Zustand Store 扩展
```typescript
// stores/colorSlice.ts
import { create } from 'zustand';
import { devtools } from 'zustand/middleware';

interface ColorParams {
  analysisDepth: 'basic' | 'standard' | 'detailed';
  colorCount: number;
  includePalette: boolean;
  includeHarmony: boolean;
  outputFormat: 'json' | 'csv' | 'palette';
}

interface ColorState {
  originalImage: string | null;
  colorAnalysisResult: any | null;
  colorParams: ColorParams;
  isProcessing: boolean;
  setOriginalImage: (image: string) => void;
  setColorParams: (params: ColorParams) => void;
  analyzeImageColors: () => Promise<void>;
}

export const useColorStore = create<ColorState>()(
  devtools((set, get) => ({
    originalImage: null,
    colorAnalysisResult: null,
    colorParams: {
      analysisDepth: 'standard',
      colorCount: 8,
      includePalette: true,
      includeHarmony: true,
      outputFormat: 'json'
    },
    isProcessing: false,
    
    setOriginalImage: (image) => set({ originalImage: image }),
    
    setColorParams: (params) => set({ colorParams: params }),
    
    analyzeImageColors: async () => {
      const { originalImage, colorParams } = get();
      if (!originalImage) return;
      
      set({ isProcessing: true });
      
      try {
        const result = await analyzeImageColors({
          imageSrc: originalImage,
          ...colorParams
        });
        
        set({ 
          colorAnalysisResult: result,
          isProcessing: false 
        });
      } catch (error) {
        set({ isProcessing: false });
        throw error;
      }
    }
  }))
);
```

## 5. UI/UX 设计

### 5.1 界面布局
```
+---------------------------------------------------------------+
| 图像色彩分析工具                                              |
+-----------+---------------------------------------------------+
| 设置面板  | 结果显示区域                                          |
|           |                                                   |
| [分析深度] | [图片预览区域]                                    |
| 基础      |                                                   |
| 标准      | [主要颜色展示]                                    |
| 详细      | [■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■■]       |
|           |                                                   |
| 颜色数量  | 色调特征:                                        |
| [----o----] | [温暖色调 75%] [冷色调 25%]                      |
| 8         |                                                   |
|           | 色彩和谐度:                                      |
| [√]调色板 | [██████████████████░░░░░░░░░░] 65%                |
| [√]和谐度 | 类型: 类似色                                      |
|           |                                                   |
| [调色板]  | [调色建议]                                       |
| 主:#FF5733 | - 增加蓝色平衡整体色调                            |
| 辅:#33FF57 | - 降低饱和度使画面更柔和                          |
| 点缀:#3357FF| - 调整亮度对比度                                 |
+-----------+---------------------------------------------------+
| [上传图片] [开始分析] [导出结果] [复制调色板]                 |
+---------------------------------------------------------------+
```

### 5.2 交互流程
1. 用户上传需要分析色彩的图片
2. 设置分析参数（深度、颜色数量等）
3. 选择是否生成调色板和和谐度分析
4. 点击"开始分析"按钮
5. 显示处理进度
6. 展示主要颜色和色彩分布
7. 显示色调特征和和谐度分析
8. 提供调色建议和调色板
9. 支持导出分析结果和复制调色板

## 6. 开发计划

### 6.1 第一阶段：基础框架搭建 (1周)
- [ ] 创建组件结构和文件
- [ ] 实现 Zustand 状态管理
- [ ] 设计 UI 组件
- [ ] 实现图片上传功能

### 6.2 第二阶段：核心功能开发 (2周)
- [ ] 实现主要颜色提取功能
- [ ] 实现色彩分布分析
- [ ] 实现色调特征识别
- [ ] 实现基础调色板生成

### 6.3 第三阶段：增强功能开发 (1周)
- [ ] 实现色彩和谐度分析
- [ ] 添加调色建议功能
- [ ] 实现多种输出格式
- [ ] 优化处理性能

### 6.4 第四阶段：测试与优化 (1周)
- [ ] 功能测试
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 文档完善

## 7. 测试方案

### 7.1 单元测试
- 测试状态管理功能
- 测试颜色提取算法
- 测试参数验证逻辑

### 7.2 集成测试
- 测试完整的色彩分析流程
- 测试不同图片类型的分析效果
- 测试调色板生成功能

### 7.3 用户验收测试
- 邀请设计师测试分析效果
- 收集用户反馈
- 优化用户体验

## 8. 部署与维护

### 8.1 部署要求
- 确保302.AI API密钥配置正确
- 验证图像上传和处理功能
- 测试不同浏览器兼容性

### 8.2 维护计划
- 监控API调用情况
- 收集用户反馈并持续优化
- 定期更新色彩分析算法
- 扩展支持的颜色空间