# 智能图像修复功能开发文档

## 1. 功能概述

### 1.1 功能名称
智能图像修复 (Smart Image Restoration)

### 1.2 功能描述
智能图像修复功能旨在通过AI技术自动识别并修复老旧、破损、模糊的图片，包括去除划痕、污渍、噪点，恢复褪色照片的色彩，以及提升图像清晰度。

### 1.3 目标用户
- 拥有老旧照片需要修复的用户
- 摄影爱好者
- 设计师和内容创作者

## 2. 功能需求

### 2.1 核心功能
1. **划痕修复**：自动检测并修复照片上的划痕
2. **污渍去除**：识别并去除照片上的污渍和斑点
3. **色彩恢复**：恢复老旧照片的自然色彩
4. **噪点消除**：去除图像中的各种噪声
5. **清晰度增强**：提升模糊图像的清晰度

### 2.2 用户界面需求
1. 上传图片区域
2. 修复参数控制面板
3. 实时预览对比功能
4. 修复强度调节滑块
5. 一键修复按钮

## 3. 技术实现方案

### 3.1 技术架构
```
前端组件层:
- ImageRestoration.tsx (主组件)
- RestorationControls.tsx (控制面板)
- RestorationPreview.tsx (预览组件)
- RestorationSlider.tsx (参数滑块)

状态管理层:
- Zustand store (扩展现有状态)
- restorationSlice.ts (修复功能状态)

API层:
- lib/api.ts (新增修复API调用)
- utils/ImageRestoration.ts (图像处理工具)

类型定义层:
- types/index.ts (新增类型定义)
```

### 3.2 API接口设计
```typescript
// 图像修复API接口
interface ImageRestorationAction {
  imageSrc: string;
  restorationType: 'scratch_removal' | 'stain_removal' | 'color_restoration' | 'denoise' | 'sharpen';
  intensity: number; // 修复强度 0-100
  preserveDetails: boolean; // 是否保留细节
}

interface ImageRestorationResult {
  imageSrc: string;
  processingTime: number; // 处理时间(ms)
}

// 主要API函数
export async function restoreImage(action: ImageRestorationAction): Promise<ImageRestorationResult> {
  // 实现图像修复逻辑
}
```

### 3.3 组件设计

#### 3.3.1 主组件 ImageRestoration.tsx
```tsx
import React from 'react';
import { RestorationControls } from './RestorationControls';
import { RestorationPreview } from './RestorationPreview';
import { useRestorationStore } from '@/stores/restorationSlice';

export function ImageRestoration() {
  const { 
    originalImage, 
    restoredImage, 
    restorationParams,
    setRestorationParams,
    restoreImage 
  } = useRestorationStore();

  return (
    <div className="image-restoration-container">
      <RestorationControls 
        params={restorationParams}
        onChange={setRestorationParams}
        onRestore={restoreImage}
      />
      <RestorationPreview 
        original={originalImage}
        restored={restoredImage}
      />
    </div>
  );
}
```

#### 3.3.2 控制面板 RestorationControls.tsx
```tsx
import React from 'react';
import { RestorationSlider } from './RestorationSlider';

interface RestorationControlsProps {
  params: RestorationParams;
  onChange: (params: RestorationParams) => void;
  onRestore: () => void;
}

export function RestorationControls({ params, onChange, onRestore }: RestorationControlsProps) {
  return (
    <div className="restoration-controls">
      <h3>图像修复参数</h3>
      
      <RestorationSlider
        label="修复强度"
        value={params.intensity}
        min={0}
        max={100}
        onChange={(value) => onChange({ ...params, intensity: value })}
      />
      
      <div className="checkbox-group">
        <label>
          <input
            type="checkbox"
            checked={params.scratchRemoval}
            onChange={(e) => onChange({ ...params, scratchRemoval: e.target.checked })}
          />
          划痕修复
        </label>
        
        <label>
          <input
            type="checkbox"
            checked={params.stainRemoval}
            onChange={(e) => onChange({ ...params, stainRemoval: e.target.checked })}
          />
          污渍去除
        </label>
        
        <label>
          <input
            type="checkbox"
            checked={params.colorRestoration}
            onChange={(e) => onChange({ ...params, colorRestoration: e.target.checked })}
          />
          色彩恢复
        </label>
      </div>
      
      <button onClick={onRestore} className="restore-button">
        开始修复
      </button>
    </div>
  );
}
```

## 4. 状态管理设计

### 4.1 Zustand Store 扩展
```typescript
// stores/restorationSlice.ts
import { create } from 'zustand';
import { devtools } from 'zustand/middleware';

interface RestorationParams {
  intensity: number;
  scratchRemoval: boolean;
  stainRemoval: boolean;
  colorRestoration: boolean;
  denoise: boolean;
  sharpen: boolean;
}

interface RestorationState {
  originalImage: string | null;
  restoredImage: string | null;
  restorationParams: RestorationParams;
  isProcessing: boolean;
  setOriginalImage: (image: string) => void;
  setRestorationParams: (params: RestorationParams) => void;
  restoreImage: () => Promise<void>;
}

export const useRestorationStore = create<RestorationState>()(
  devtools((set, get) => ({
    originalImage: null,
    restoredImage: null,
    restorationParams: {
      intensity: 50,
      scratchRemoval: true,
      stainRemoval: true,
      colorRestoration: true,
      denoise: true,
      sharpen: true,
    },
    isProcessing: false,
    
    setOriginalImage: (image) => set({ originalImage: image }),
    
    setRestorationParams: (params) => set({ restorationParams: params }),
    
    restoreImage: async () => {
      const { originalImage, restorationParams } = get();
      if (!originalImage) return;
      
      set({ isProcessing: true });
      
      try {
        const result = await restoreImage({
          imageSrc: originalImage,
          ...restorationParams
        });
        
        set({ 
          restoredImage: result.imageSrc,
          isProcessing: false 
        });
      } catch (error) {
        set({ isProcessing: false });
        throw error;
      }
    }
  }))
);
```

## 5. UI/UX 设计

### 5.1 界面布局
```
+-----------------------------------------------------+
| 图像修复工具                                       |
+----------------------+-----------------------------+
| 控制面板             | 预览区域                    |
|                      |                             |
| [修复强度: 50% ----o]| [原始图片]  [修复后图片]    |
|                      |                             |
| [√] 划痕修复         |                             |
| [√] 污渍去除         |                             |
| [√] 色彩恢复         |                             |
| [√] 降噪处理         |                             |
| [√] 锐化处理         |                             |
|                      |                             |
| [开始修复]           |                             |
+----------------------+-----------------------------+
```

### 5.2 交互流程
1. 用户上传需要修复的图片
2. 用户调整修复参数
3. 实时预览修复效果（可选）
4. 点击"开始修复"按钮
5. 显示处理进度
6. 展示修复后的图片
7. 提供下载和继续编辑选项

## 6. 开发计划

### 6.1 第一阶段：基础框架搭建 (1周)
- [ ] 创建组件结构和文件
- [ ] 实现 Zustand 状态管理
- [ ] 设计 UI 组件
- [ ] 实现图片上传功能

### 6.2 第二阶段：核心功能开发 (2周)
- [ ] 实现划痕修复功能
- [ ] 实现污渍去除功能
- [ ] 实现色彩恢复功能
- [ ] 实现降噪处理功能

### 6.3 第三阶段：增强功能开发 (1周)
- [ ] 实现锐化处理功能
- [ ] 添加实时预览功能
- [ ] 优化处理性能

### 6.4 第四阶段：测试与优化 (1周)
- [ ] 功能测试
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 文档完善

## 7. 测试方案

### 7.1 单元测试
- 测试状态管理功能
- 测试参数验证逻辑
- 测试图像处理函数

### 7.2 集成测试
- 测试完整的修复流程
- 测试不同参数组合的效果
- 测试边界条件处理

### 7.3 用户验收测试
- 邀请用户测试修复效果
- 收集用户反馈
- 优化用户体验

## 8. 部署与维护

### 8.1 部署要求
- 确保302.AI API密钥配置正确
- 验证图像上传和处理功能
- 测试不同浏览器兼容性

### 8.2 维护计划
- 定期更新AI模型
- 监控API调用情况
- 收集用户反馈并持续优化