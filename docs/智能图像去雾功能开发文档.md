# 智能图像去雾功能开发文档

## 1. 功能概述

### 1.1 功能名称
智能图像去雾 (Intelligent Image Dehazing)

### 1.2 功能描述
智能图像去雾功能利用先进的AI算法处理雾霾、雾气、水汽等影响图片清晰度的天气因素，恢复图片的清晰度和色彩饱和度。该功能可有效改善因雾霾、水下拍摄或玻璃反光导致的图片模糊问题。

### 1.3 目标用户
- 风景摄影师
- 无人机操作员
- 水下摄影爱好者
- 监控系统操作人员
- 需要改善雾霾图片质量的普通用户

## 2. 功能需求

### 2.1 核心功能
1. **自动雾霾检测**：智能识别图片中的雾霾程度
2. **去雾处理**：去除雾霾、雾气等影响清晰度的因素
3. **色彩恢复**：恢复因雾霾而失真的色彩饱和度
4. **对比度增强**：提升图片的明暗对比度
5. **细节增强**：增强图片细节表现
6. **透明物体处理**：处理玻璃、水面等透明物体的反光

### 2.2 用户界面需求
1. 图片上传区域
2. 雾霾程度检测显示
3. 去雾强度调节滑块
4. 实时预览窗口
5. 前后对比视图
6. 处理进度显示

## 3. 技术实现方案

### 3.1 技术架构
```
前端组件层:
- DehazingProcessor.tsx (主组件)
- FogDetectionView.tsx (雾霾检测视图)
- DehazingControls.tsx (去雾控制面板)
- IntensitySlider.tsx (强度调节滑块)
- DehazingPreview.tsx (预览组件)

状态管理层:
- Zustand store (扩展现有状态)
- dehazingSlice.ts (去雾功能状态)

API层:
- lib/api.ts (新增去雾API调用)
- utils/ImageDehazing.ts (图像去雾工具)

类型定义层:
- types/index.ts (新增类型定义)
```

### 3.2 API接口设计
```typescript
// 智能图像去雾API接口
interface ImageDehazingAction {
  imageSrc: string;
  dehazingMode: 'auto' | 'manual' | 'adaptive';
  intensity: number; // 去雾强度 0-100
  colorEnhancement: number; // 色彩增强 0-100
  contrastEnhancement: number; // 对比度增强 0-100
  detailEnhancement: number; // 细节增强 0-100
  transparentObjectHandling: boolean; // 透明物体处理
  outputFormat?: 'png' | 'jpg' | 'webp';
}

interface FogDetectionResult {
  fogLevel: number; // 雾霾程度 0-100
  fogDistribution: {
    light: number; // 轻度雾霾区域占比
    medium: number; // 中度雾霾区域占比
    heavy: number; // 重度雾霾区域占比
  };
  recommendedIntensity: number; // 推荐去雾强度
}

interface ImageDehazingResult {
  imageSrc: string;
  fogDetection?: FogDetectionResult;
  processingTime: number; // 处理时间(ms)
  qualityImprovement: number; // 质量提升百分比 0-100
}

// 主要API函数
export async function dehazeImage(action: ImageDehazingAction): Promise<ImageDehazingResult> {
  // 实现智能图像去雾逻辑
}
```

### 3.3 组件设计

#### 3.3.1 主组件 DehazingProcessor.tsx
```tsx
import React from 'react';
import { FogDetectionView } from './FogDetectionView';
import { DehazingControls } from './DehazingControls';
import { DehazingPreview } from './DehazingPreview';
import { useDehazingStore } from '@/stores/dehazingSlice';

export function DehazingProcessor() {
  const { 
    originalImage, 
    dehazedImage, 
    dehazingParams,
    fogDetectionResult,
    setDehazingParams,
    dehazeImage,
    isProcessing
  } = useDehazingStore();

  return (
    <div className="dehazing-processor-container">
      <div className="processor-header">
        <h2>智能图像去雾</h2>
        <p>去除雾霾、雾气等影响，恢复图片清晰度和色彩</p>
      </div>
      
      <div className="processor-content">
        <div className="processor-sidebar">
          <DehazingControls 
            params={dehazingParams}
            fogDetection={fogDetectionResult}
            onChange={setDehazingParams}
            onDehaze={dehazeImage}
            onAutoDetect={() => {
              // 自动检测雾霾程度
            }}
            isProcessing={isProcessing}
          />
        </div>
        
        <div className="processor-main">
          {originalImage && (
            <FogDetectionView 
              image={originalImage}
              fogDetection={fogDetectionResult}
              dehazedImage={dehazedImage}
              isProcessing={isProcessing}
            />
          )}
        </div>
      </div>
    </div>
  );
}
```

#### 3.3.2 雾霾检测视图 FogDetectionView.tsx
```tsx
import React from 'react';

interface FogDetectionViewProps {
  image: string;
  fogDetection: any;
  dehazedImage: string | null;
  isProcessing: boolean;
}

export function FogDetectionView({ 
  image, 
  fogDetection, 
  dehazedImage, 
  isProcessing 
}: FogDetectionViewProps) {
  return (
    <div className="fog-detection-view">
      {isProcessing ? (
        <div className="processing-overlay">
          <div className="spinner"></div>
          <p>正在去雾处理...</p>
        </div>
      ) : dehazedImage ? (
        <div className="before-after-comparison">
          <div className="image-container">
            <h4>处理前</h4>
            <img src={image} alt="原图" />
          </div>
          <div className="image-container">
            <h4>处理后</h4>
            <img src={dehazedImage} alt="去雾后" />
          </div>
        </div>
      ) : (
        <div className="fog-detection-result">
          <div className="image-preview">
            <img src={image} alt="待处理图片" />
          </div>
          
          {fogDetection && (
            <div className="detection-info">
              <h3>雾霾检测结果</h3>
              <div className="fog-level">
                <span>雾霾程度: {fogDetection.fogLevel}%</span>
                <div className="level-bar">
                  <div 
                    className="level-fill"
                    style={{ width: `${fogDetection.fogLevel}%` }}
                  ></div>
                </div>
              </div>
              
              <div className="distribution">
                <h4>雾霾分布</h4>
                <div className="distribution-item">
                  <span>轻度: {fogDetection.fogDistribution.light}%</span>
                </div>
                <div className="distribution-item">
                  <span>中度: {fogDetection.fogDistribution.medium}%</span>
                </div>
                <div className="distribution-item">
                  <span>重度: {fogDetection.fogDistribution.heavy}%</span>
                </div>
              </div>
              
              <div className="recommendation">
                <p>推荐去雾强度: {fogDetection.recommendedIntensity}%</p>
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## 4. 状态管理设计

### 4.1 Zustand Store 扩展
```typescript
// stores/dehazingSlice.ts
import { create } from 'zustand';
import { devtools } from 'zustand/middleware';

interface DehazingParams {
  dehazingMode: 'auto' | 'manual' | 'adaptive';
  intensity: number;
  colorEnhancement: number;
  contrastEnhancement: number;
  detailEnhancement: number;
  transparentObjectHandling: boolean;
}

interface DehazingState {
  originalImage: string | null;
  dehazedImage: string | null;
  dehazingParams: DehazingParams;
  fogDetectionResult: any | null;
  isProcessing: boolean;
  setOriginalImage: (image: string) => void;
  setDehazingParams: (params: DehazingParams) => void;
  dehazeImage: () => Promise<void>;
}

export const useDehazingStore = create<DehazingState>()(
  devtools((set, get) => ({
    originalImage: null,
    dehazedImage: null,
    dehazingParams: {
      dehazingMode: 'auto',
      intensity: 50,
      colorEnhancement: 30,
      contrastEnhancement: 20,
      detailEnhancement: 25,
      transparentObjectHandling: true
    },
    fogDetectionResult: null,
    isProcessing: false,
    
    setOriginalImage: (image) => set({ originalImage: image }),
    
    setDehazingParams: (params) => set({ dehazingParams: params }),
    
    dehazeImage: async () => {
      const { originalImage, dehazingParams } = get();
      if (!originalImage) return;
      
      set({ isProcessing: true });
      
      try {
        const result = await dehazeImage({
          imageSrc: originalImage,
          ...dehazingParams
        });
        
        set({ 
          dehazedImage: result.imageSrc,
          fogDetectionResult: result.fogDetection,
          isProcessing: false 
        });
      } catch (error) {
        set({ isProcessing: false });
        throw error;
      }
    }
  }))
);
```

## 5. UI/UX 设计

### 5.1 界面布局
```
+---------------------------------------------------------------+
| 智能图像去雾工具                                              |
+-----------+---------------------------------------------------+
| 控制面板  | 预览区域                                              |
|           |                                                   |
| [自动检测] | [图片预览/雾霾检测/前后对比]                        |
|           |                                                   |
| 去雾模式  |                                                   |
| [自动]    |                                                   |
| [手动]    |                                                   |
| [自适应]  |                                                   |
|           |                                                   |
| 去雾强度  |                                                   |
| [----o----] 50%                                             |
|           |                                                   |
| 色彩增强  |                                                   |
| [----o----] 30%                                             |
|           |                                                   |
| 对比度增强|                                                   |
| [----o----] 20%                                             |
|           |                                                   |
| 细节增强  |                                                   |
| [----o----] 25%                                             |
|           |                                                   |
| [√]透明物体处理                                              |
|           |                                                   |
| [开始去雾] |                                                   |
+-----------+---------------------------------------------------+
| [上传图片] [下载结果]                                         |
+---------------------------------------------------------------+
```

### 5.2 交互流程
1. 用户上传需要去雾的图片
2. 点击"自动检测"分析雾霾程度
3. 查看雾霾检测结果和推荐参数
4. 调整去雾参数（强度、色彩、对比度等）
5. 实时预览去雾效果
6. 点击"开始去雾"按钮
7. 显示处理进度
8. 展示去雾后的图片
9. 提供下载和继续编辑选项

## 6. 开发计划

### 6.1 第一阶段：基础框架搭建 (1周)
- [ ] 创建组件结构和文件
- [ ] 实现 Zustand 状态管理
- [ ] 设计 UI 组件
- [ ] 实现图片上传功能

### 6.2 第二阶段：核心功能开发 (2周)
- [ ] 实现自动雾霾检测功能
- [ ] 实现基础去雾处理功能
- [ ] 实现色彩恢复功能
- [ ] 实现对比度增强功能

### 6.3 第三阶段：增强功能开发 (1周)
- [ ] 实现细节增强功能
- [ ] 实现透明物体处理功能
- [ ] 添加多种去雾模式
- [ ] 优化处理性能

### 6.4 第四阶段：测试与优化 (1周)
- [ ] 功能测试
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 文档完善

## 7. 测试方案

### 7.1 单元测试
- 测试状态管理功能
- 测试雾霾检测算法
- 测试参数验证逻辑

### 7.2 集成测试
- 测试完整的去雾处理流程
- 测试不同雾霾程度图片的处理效果
- 测试参数组合的效果

### 7.3 用户验收测试
- 邀请摄影师测试去雾效果
- 收集用户反馈
- 优化用户体验

## 8. 部署与维护

### 8.1 部署要求
- 确保302.AI API密钥配置正确
- 验证图像上传和处理功能
- 测试不同浏览器兼容性

### 8.2 维护计划
- 监控API调用情况
- 收集用户反馈并持续优化
- 定期更新去雾算法
- 扩展支持的去雾场景