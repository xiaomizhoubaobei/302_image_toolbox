# 智能图像合成功能开发文档

## 1. 功能概述

### 1.1 功能名称
智能图像合成 (Smart Image Composition)

### 1.2 功能描述
智能图像合成功能允许用户将多张图片智能融合生成自然的合成图像。通过AI技术实现对象识别、背景融合、光照匹配和色彩协调，创建高质量的合成作品。

### 1.3 目标用户
- 平面设计师
- 摄影师
- 内容创作者
- 社交媒体用户

## 2. 功能需求

### 2.1 核心功能
1. **多图融合**：支持2-5张图片的智能融合
2. **对象识别**：自动识别图片中的主体对象
3. **背景合成**：智能背景替换和融合
4. **光照匹配**：自动调整光照效果保持一致性
5. **色彩协调**：统一合成图像的色彩风格
6. **图层管理**：支持图层操作和混合模式

### 2.2 用户界面需求
1. 多图上传区域
2. 对象选择和编辑工具
3. 合成参数控制面板
4. 实时预览窗口
5. 图层管理面板
6. 处理进度显示

## 3. 技术实现方案

### 3.1 技术架构
```
前端组件层:
- ImageComposer.tsx (主组件)
- CompositionCanvas.tsx (合成画布)
- LayerManager.tsx (图层管理器)
- CompositionControls.tsx (控制面板)
- ObjectSelector.tsx (对象选择器)

状态管理层:
- Zustand store (扩展现有状态)
- compositionSlice.ts (合成功能状态)

API层:
- lib/api.ts (新增合成API调用)
- utils/ImageComposition.ts (图像合成工具)

类型定义层:
- types/index.ts (新增类型定义)
```

### 3.2 API接口设计
```typescript
// 图像合成API接口
interface ImageCompositionAction {
  images: Array<{
    src: string;
    position: { x: number; y: number };
    scale: number;
    rotation: number;
    opacity: number;
  }>;
  compositionMode: 'auto_blend' | 'manual_blend' | 'scene_merge';
  blendSettings: {
    lightingMatch: boolean;
    colorHarmony: boolean;
    edgeSmooth: boolean;
    shadowEnhance: boolean;
  };
  outputSize?: { width: number; height: number };
}

interface ImageCompositionResult {
  imageSrc: string;
  processingTime: number; // 处理时间(ms)
  compositionDetails: {
    objectsDetected: number;
    blendQuality: 'high' | 'medium' | 'low';
  };
}

// 合成模式定义
type CompositionMode = 
  | 'auto_blend'      // 自动融合
  | 'manual_blend'    // 手动融合
  | 'scene_merge';    // 场景合并

// 主要API函数
export async function composeImages(action: ImageCompositionAction): Promise<ImageCompositionResult> {
  // 实现图像合成逻辑
}
```

### 3.3 组件设计

#### 3.3.1 主组件 ImageComposer.tsx
```tsx
import React from 'react';
import { CompositionCanvas } from './CompositionCanvas';
import { LayerManager } from './LayerManager';
import { CompositionControls } from './CompositionControls';
import { ObjectSelector } from './ObjectSelector';
import { useCompositionStore } from '@/stores/compositionSlice';

export function ImageComposer() {
  const { 
    images, 
    composedImage, 
    compositionParams,
    layers,
    setCompositionParams,
    composeImages,
    isProcessing
  } = useCompositionStore();

  return (
    <div className="image-composer-container">
      <div className="composer-header">
        <h2>智能图像合成</h2>
        <p>将多张图片智能融合生成精美合成作品</p>
      </div>
      
      <div className="composer-content">
        <div className="composer-sidebar">
          <ObjectSelector 
            images={images}
            onObjectSelect={(imageId, objectId) => {
              // 处理对象选择
            }}
          />
          
          <LayerManager 
            layers={layers}
            onLayerChange={(updatedLayers) => {
              // 更新图层
            }}
          />
        </div>
        
        <div className="composer-main">
          <CompositionCanvas 
            images={images}
            composedImage={composedImage}
            layers={layers}
            isProcessing={isProcessing}
          />
        </div>
        
        <div className="composer-controls">
          <CompositionControls 
            params={compositionParams}
            onChange={setCompositionParams}
            onCompose={composeImages}
            isProcessing={isProcessing}
          />
        </div>
      </div>
    </div>
  );
}
```

#### 3.3.2 合成画布 CompositionCanvas.tsx
```tsx
import React from 'react';
import { Stage, Layer, Image } from 'react-konva';

interface CompositionCanvasProps {
  images: Array<{
    id: string;
    src: string;
    position: { x: number; y: number };
    scale: number;
    rotation: number;
    opacity: number;
  }>;
  composedImage: string | null;
  layers: any[];
  isProcessing: boolean;
}

export function CompositionCanvas({ images, composedImage, layers, isProcessing }: CompositionCanvasProps) {
  return (
    <div className="composition-canvas">
      {isProcessing ? (
        <div className="processing-overlay">
          <div className="spinner"></div>
          <p>正在合成图像...</p>
        </div>
      ) : composedImage ? (
        <div className="final-result">
          <img src={composedImage} alt="合成结果" />
        </div>
      ) : (
        <Stage width={800} height={600} className="composition-stage">
          <Layer>
            {images.map((image) => (
              <Image
                key={image.id}
                image={image.src}
                x={image.position.x}
                y={image.position.y}
                scaleX={image.scale}
                scaleY={image.scale}
                rotation={image.rotation}
                opacity={image.opacity}
                draggable
                onDragEnd={(e) => {
                  // 更新图像位置
                }}
              />
            ))}
          </Layer>
        </Stage>
      )}
    </div>
  );
}
```

## 4. 状态管理设计

### 4.1 Zustand Store 扩展
```typescript
// stores/compositionSlice.ts
import { create } from 'zustand';
import { devtools } from 'zustand/middleware';

interface CompositionImage {
  id: string;
  src: string;
  position: { x: number; y: number };
  scale: number;
  rotation: number;
  opacity: number;
}

interface CompositionParams {
  compositionMode: 'auto_blend' | 'manual_blend' | 'scene_merge';
  blendSettings: {
    lightingMatch: boolean;
    colorHarmony: boolean;
    edgeSmooth: boolean;
    shadowEnhance: boolean;
  };
  outputSize?: { width: number; height: number };
}

interface CompositionLayer {
  id: string;
  name: string;
  visible: boolean;
  locked: boolean;
  opacity: number;
  blendMode: string;
}

interface CompositionState {
  images: CompositionImage[];
  composedImage: string | null;
  compositionParams: CompositionParams;
  layers: CompositionLayer[];
  isProcessing: boolean;
  addImage: (image: Omit<CompositionImage, 'id'>) => void;
  removeImage: (imageId: string) => void;
  updateImage: (imageId: string, updates: Partial<CompositionImage>) => void;
  setCompositionParams: (params: CompositionParams) => void;
  composeImages: () => Promise<void>;
}

export const useCompositionStore = create<CompositionState>()(
  devtools((set, get) => ({
    images: [],
    composedImage: null,
    compositionParams: {
      compositionMode: 'auto_blend',
      blendSettings: {
        lightingMatch: true,
        colorHarmony: true,
        edgeSmooth: true,
        shadowEnhance: true,
      }
    },
    layers: [],
    isProcessing: false,
    
    addImage: (image) => {
      const newImage = {
        ...image,
        id: Math.random().toString(36).substr(2, 9)
      };
      set((state) => ({
        images: [...state.images, newImage]
      }));
    },
    
    removeImage: (imageId) => {
      set((state) => ({
        images: state.images.filter(img => img.id !== imageId)
      }));
    },
    
    updateImage: (imageId, updates) => {
      set((state) => ({
        images: state.images.map(img => 
          img.id === imageId ? { ...img, ...updates } : img
        )
      }));
    },
    
    setCompositionParams: (params) => set({ compositionParams: params }),
    
    composeImages: async () => {
      const { images, compositionParams } = get();
      if (images.length < 2) return;
      
      set({ isProcessing: true });
      
      try {
        const result = await composeImages({
          images: images.map(img => ({
            src: img.src,
            position: img.position,
            scale: img.scale,
            rotation: img.rotation,
            opacity: img.opacity
          })),
          ...compositionParams
        });
        
        set({ 
          composedImage: result.imageSrc,
          isProcessing: false 
        });
      } catch (error) {
        set({ isProcessing: false });
        throw error;
      }
    }
  }))
);
```

## 5. UI/UX 设计

### 5.1 界面布局
```
+---------------------------------------------------------------+
| 智能图像合成工具                                              |
+-----------+----------------------+---------------------------+
| 对象面板  | 合成画布             | 控制面板                  |
|           |                      |                           |
| [图片1]   | [合成预览区域]       | [合成模式]                |
| [图片2]   |                      |  自动融合  手动融合       |
| [图片3]   |                      |                           |
|           |                      | [光照匹配] [√]            |
| 图层管理  |                      | [色彩协调] [√]            |
|           |                      | [边缘平滑] [√]            |
| [图层1]   |                      | [阴影增强] [√]            |
| [图层2]   |                      |                           |
| [图层3]   |                      | [合成强度: 80% ----o]     |
+-----------+----------------------+---------------------------+
| [添加图片] [开始合成] [重置]                                  |
+---------------------------------------------------------------+
```

### 5.2 交互流程
1. 用户上传多张需要合成的图片
2. 系统自动识别图片中的主体对象
3. 用户在画布上调整图片位置、大小和旋转
4. 用户设置合成参数和混合选项
5. 实时预览合成效果
6. 点击"开始合成"按钮
7. 显示处理进度
8. 展示合成后的图片
9. 提供下载和继续编辑选项

## 6. 开发计划

### 6.1 第一阶段：基础框架搭建 (1周)
- [ ] 创建组件结构和文件
- [ ] 实现 Zustand 状态管理
- [ ] 设计 UI 组件
- [ ] 实现多图上传功能

### 6.2 第二阶段：核心功能开发 (2周)
- [ ] 实现自动融合功能
- [ ] 实现对象识别和选择
- [ ] 实现图层管理系统
- [ ] 实现基本的画布操作

### 6.3 第三阶段：增强功能开发 (1周)
- [ ] 实现光照匹配功能
- [ ] 实现色彩协调功能
- [ ] 添加手动融合模式
- [ ] 优化处理性能

### 6.4 第四阶段：测试与优化 (1周)
- [ ] 功能测试
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 文档完善

## 7. 测试方案

### 7.1 单元测试
- 测试状态管理功能
- 测试图层操作逻辑
- 测试参数验证逻辑

### 7.2 集成测试
- 测试完整的图像合成流程
- 测试不同合成模式的效果
- 测试多图处理能力

### 7.3 用户验收测试
- 邀请设计师测试合成效果
- 收集用户反馈
- 优化用户体验

## 8. 部署与维护

### 8.1 部署要求
- 确保302.AI API密钥配置正确
- 验证图像上传和处理功能
- 测试不同浏览器兼容性

### 8.2 维护计划
- 定期更新AI模型
- 添加新的合成模式
- 监控API调用情况
- 收集用户反馈并持续优化