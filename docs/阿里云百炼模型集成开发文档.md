# 阿里云百炼模型集成开发文档

## 1. 功能概述

### 1.1 功能名称
阿里云百炼模型集成 (Aliyun Bailian Model Integration)

### 1.2 功能描述
阿里云百炼模型集成功能旨在将阿里云百炼平台的多种AI图像处理模型集成到302.AI图片工具箱中，为用户提供丰富多样的AI图像处理选项。阿里云百炼提供了包括文生图、图像编辑、风格迁移、背景生成、图像扩图、虚拟模特生成、鞋靴试穿、创意海报生成、实例分割、图像擦除补全、局部重绘、涂鸦作画等多种功能。

### 1.3 目标用户
- 需要多样化图像处理功能的用户
- 对阿里云百炼模型有特定需求的设计师和内容创作者
- 希望在统一平台使用多种AI模型的开发者

## 2. 功能需求

### 2.1 核心功能
1. **文生图功能**：支持通过文本描述生成图像（Qwen-Image、 Wan系列）
2. **图像编辑功能**：支持多图编辑，精确修改图内文字、增删或移动物体、改变主体动作、迁移图片风格及增强画面细节（Qwen-Image-Edit）
3. **风格重绘功能**：将人物照片转换为多种预设或自定义的艺术风格（wanx-style-repaint-v1）
4. **背景生成功能**：为商品换背景，支持文本引导、图像引导或两者结合（wanx-background-generation-v2）
5. **图像扩图功能**：支持指定宽高比扩图、指定横向或纵向扩展比例、自定义方向扩展像素数（image-out-painting）
6. **虚拟模特生成功能**：保持真人实拍模特站姿不变的前提下，对拍摄背景图、模特进行替换（virtualmodel-v2）
7. **鞋靴试穿功能**：对输入模特模板图的鞋子区域进行鞋靴AI试穿（shoemodel-v1）
8. **创意海报生成功能**：根据要求自动生成海报的背景和文字排版，支持多种海报风格（wanx-poster-generation-v1）
9. **实例分割功能**：识别出图像中的不同人物对象，并画出每个对象边界的像素级掩码（image-instance-segmentation）
10. **图像擦除补全功能**：在保留原图背景的同时擦除指定图像区域（image-erase-completion）
11. **局部重绘功能**：根据原始图片、局部涂抹图和文本描述，完成图像的二次创作（wanx-x-painting）
12. **涂鸦作画功能**：根据手绘图加上文字描述，生成精美的涂鸦绘画作品（wanx-sketch-to-image-lite）

### 2.2 用户界面需求
1. 模型选择下拉菜单
2. 图像参数配置控件（分辨率、生成数量等）
3. 文本输入框（提示词、反向提示词）
4. 图像上传区域
5. 风格选择器
6. 扩图参数设置
7. 掩码编辑工具
8. 预览区域

## 3. 技术实现方案

### 3.1 技术架构
```
前端组件层:
- BailianModelSelector.tsx (模型选择组件)
- BailianControls.tsx (参数控制面板)
- BailianImageGenerator.tsx (图像生成主组件)
- BailianImageEditor.tsx (图像编辑组件)
- BailianStyleRepaint.tsx (风格重绘组件)
- BailianBackgroundGenerator.tsx (背景生成组件)
- BailianImageExpansion.tsx (图像扩图组件)
- BailianVirtualModel.tsx (虚拟模特组件)
- BailianShoeModel.tsx (鞋靴试穿组件)
- BailianPosterGenerator.tsx (创意海报组件)
- BailianInstanceSegmentation.tsx (实例分割组件)
- BailianEraseCompletion.tsx (图像擦除补全组件)
- BailianVaryRegion.tsx (局部重绘组件)
- BailianSketchToImage.tsx (涂鸦作画组件)

状态管理层:
- Zustand store (扩展全局状态)
- bailianSlice.ts (阿里云百炼功能状态)

API层:
- lib/api.ts (新增阿里云百炼API调用)
- utils/Bailian.ts (阿里云百炼工具函数)

类型定义层:
- types/index.ts (新增类型定义)
```

### 3.2 API接口设计
```typescript
// 阿里云百炼通用API接口
interface BailianAction {
  prompt?: string;
  negativePrompt?: string;
  model: string; // 模型名称
  size?: string; // 图像分辨率
  n?: number; // 生成图片数量
  promptExtend?: boolean; // 是否开启prompt智能改写
  watermark?: boolean; // 是否添加水印
  seed?: number; // 随机数种子
  // 其他特定模型参数
  [key: string]: any;
}

interface BailianResult {
  imageUrls: string[]; // 生成的图像URL列表
  taskId?: string; // 任务ID
  processingTime?: number; // 处理时间(ms)
  actualPrompt?: string; // 实际使用的提示词（开启智能改写时）
  [key: string]: any; // 其他特定模型返回数据
}

// 主要API函数
export async function bailianGenerateImage(action: BailianAction): Promise<BailianResult> {
  // 实现阿里云百炼图像生成逻辑
}

// 任务状态查询API
interface BailianTaskStatus {
  taskId: string;
  taskStatus: 'PENDING' | 'RUNNING' | 'SUCCEEDED' | 'FAILED' | 'CANCELED' | 'UNKNOWN';
  results?: Array<{ url: string }>;
  [key: string]: any; // 其他特定模型返回数据
}

export async function getBailianTaskStatus(taskId: string): Promise<BailianTaskStatus> {
  // 查询阿里云百炼任务状态
}

// 特定模型API函数
export async function bailianTextToImage(action: BailianAction): Promise<BailianResult> {
  // 文生图功能
}

export async function bailianImageEdit(action: BailianAction): Promise<BailianResult> {
  // 图像编辑功能
}

export async function bailianStyleRepaint(action: BailianAction): Promise<BailianResult> {
  // 风格重绘功能
}

export async function bailianBackgroundGeneration(action: BailianAction): Promise<BailianResult> {
  // 背景生成功能
}

export async function bailianImageExpansion(action: BailianAction): Promise<BailianResult> {
  // 图像扩图功能
}

export async function bailianVirtualModel(action: BailianAction): Promise<BailianResult> {
  // 虚拟模特生成功能
}

export async function bailianShoeModel(action: BailianAction): Promise<BailianResult> {
  // 鞋靴试穿功能
}

export async function bailianPosterGeneration(action: BailianAction): Promise<BailianResult> {
  // 创意海报生成功能
}

export async function bailianInstanceSegmentation(action: BailianAction): Promise<BailianResult> {
  // 实例分割功能
}

export async function bailianEraseCompletion(action: BailianAction): Promise<BailianResult> {
  // 图像擦除补全功能
}

export async function bailianVaryRegion(action: BailianAction): Promise<BailianResult> {
  // 局部重绘功能
}

export async function bailianSketchToImage(action: BailianAction): Promise<BailianResult> {
  // 涂鸦作画功能
}
```

### 3.3 组件设计

#### 3.3.1 模型选择组件 BailianModelSelector.tsx
```tsx
import React from 'react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';

interface BailianModelSelectorProps {
  value: string;
  onChange: (model: string) => void;
}

export function BailianModelSelector({ value, onChange }: BailianModelSelectorProps) {
  const models = [
    // 文生图模型
    { name: '通义千问Qwen-Image Plus', value: 'qwen-image-plus' },
    { name: '通义万相 Wan 2.2 Plus', value: 'wan2.2-t2i-plus' },
    { name: '通义万相 Wan 2.2 Flash', value: 'wan2.2-t2i-flash' },
    { name: '通义万相 Wan 2.1 Turbo', value: 'wanx2.1-t2i-turbo' },
    { name: '通义万相 Wan 2.1 Plus', value: 'wanx2.1-t2i-plus' },
    
    // 图像编辑模型
    { name: '通义千问Qwen-Image-Edit', value: 'qwen-image-edit' },
    
    // 风格重绘模型
    { name: '通义万相风格重绘', value: 'wanx-style-repaint-v1' },
    
    // 背景生成模型
    { name: '通义万相背景生成', value: 'wanx-background-generation-v2' },
    
    // 图像扩图模型
    { name: '图像扩图', value: 'image-out-painting' },
    
    // 虚拟模特模型
    { name: '虚拟模特V2', value: 'virtualmodel-v2' },
    
    // 鞋靴试穿模型
    { name: '鞋靴试穿', value: 'shoemodel-v1' },
    
    // 创意海报模型
    { name: '创意海报生成', value: 'wanx-poster-generation-v1' },
    
    // 实例分割模型
    { name: '实例分割', value: 'image-instance-segmentation' },
    
    // 图像擦除补全模型
    { name: '图像擦除补全', value: 'image-erase-completion' },
    
    // 局部重绘模型
    { name: '局部重绘', value: 'wanx-x-painting' },
    
    // 涂鸦作画模型
    { name: '涂鸦作画', value: 'wanx-sketch-to-image-lite' },
  ];

  return (
    <div className="bailian-model-selector">
      <label>选择模型</label>
      <Select value={value} onValueChange={onChange}>
        <SelectTrigger>
          <SelectValue placeholder="选择阿里云百炼模型" />
        </SelectTrigger>
        <SelectContent>
          {models.map((model) => (
            <SelectItem key={model.value} value={model.value}>
              {model.name}
            </SelectItem>
          ))}
        </SelectContent>
      </Select>
    </div>
  );
}
```

#### 3.3.2 参数控制面板 BailianControls.tsx
```tsx
import React from 'react';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Slider } from '@/components/ui/slider';
import { Switch } from '@/components/ui/switch';
import { Textarea } from '@/components/ui/textarea';
import { BailianModelSelector } from './BailianModelSelector';

interface BailianParams {
  model: string;
  size: string;
  n: number;
  prompt: string;
  negativePrompt: string;
  promptExtend: boolean;
  watermark: boolean;
  // 特定模型参数
  styleIndex?: number;
  angle?: number;
  xScale?: number;
  yScale?: number;
  [key: string]: any;
}

interface BailianControlsProps {
  params: BailianParams;
  onChange: (params: BailianParams) => void;
}

export function BailianControls({ params, onChange }: BailianControlsProps) {
  const sizeOptions = [
    '512*512', '768*768', '1024*1024', '1280*1280',
    '800*1200', '1200*800', '960*1280', '1280*960',
    '1664*928', '928*1664', '1328*1328', '1472*1140', '1140*1472'
  ];

  // 根据选择的模型显示不同的参数控件
  const renderModelSpecificControls = () => {
    switch (params.model) {
      case 'wanx-style-repaint-v1':
        return (
          <div className="control-group">
            <Label>风格选择</Label>
            <select
              value={params.styleIndex || 0}
              onChange={(e) => onChange({ ...params, styleIndex: parseInt(e.target.value) })}
              className="w-full p-2 border rounded"
            >
              <option value={0}>复古漫画</option>
              <option value={1}>3D童话</option>
              <option value={2}>二次元</option>
              <option value={3}>小清新</option>
              <option value={4}>未来科技</option>
              <option value={5}>国画古风</option>
              <option value={6}>将军百战</option>
            </select>
          </div>
        );
      
      case 'image-out-painting':
        return (
          <>
            <div className="control-group">
              <Label>旋转角度</Label>
              <Slider
                value={[params.angle || 0]}
                min={0}
                max={360}
                step={1}
                onValueChange={([angle]) => onChange({ ...params, angle })}
              />
              <div>当前角度: {params.angle || 0}°</div>
            </div>
            <div className="control-group">
              <Label>X轴缩放比例</Label>
              <Slider
                value={[params.xScale || 1]}
                min={0.5}
                max={3}
                step={0.1}
                onValueChange={([xScale]) => onChange({ ...params, xScale })}
              />
              <div>当前比例: {params.xScale || 1}</div>
            </div>
            <div className="control-group">
              <Label>Y轴缩放比例</Label>
              <Slider
                value={[params.yScale || 1]}
                min={0.5}
                max={3}
                step={0.1}
                onValueChange={([yScale]) => onChange({ ...params, yScale })}
              />
              <div>当前比例: {params.yScale || 1}</div>
            </div>
          </>
        );
      
      default:
        return null;
    }
  };

  return (
    <div className="bailian-controls">
      <h3>阿里云百炼参数设置</h3>
      
      <BailianModelSelector 
        value={params.model} 
        onChange={(model) => onChange({ ...params, model })} 
      />
      
      <div className="control-group">
        <Label>提示词</Label>
        <Textarea
          value={params.prompt}
          onChange={(e) => onChange({ ...params, prompt: e.target.value })}
          placeholder="输入提示词"
        />
      </div>
      
      <div className="control-group">
        <Label>反向提示词</Label>
        <Textarea
          value={params.negativePrompt}
          onChange={(e) => onChange({ ...params, negativePrompt: e.target.value })}
          placeholder="输入不希望出现的内容"
        />
      </div>
      
      <div className="control-group">
        <Label>图像分辨率</Label>
        <select
          value={params.size}
          onChange={(e) => onChange({ ...params, size: e.target.value })}
          className="w-full p-2 border rounded"
        >
          {sizeOptions.map((size) => (
            <option key={size} value={size}>{size}</option>
          ))}
        </select>
      </div>
      
      <div className="control-group">
        <Label>生成数量: {params.n}</Label>
        <Slider
          value={[params.n]}
          min={1}
          max={4}
          step={1}
          onValueChange={([n]) => onChange({ ...params, n })}
        />
      </div>
      
      <div className="control-group flex items-center justify-between">
        <Label>智能改写</Label>
        <Switch
          checked={params.promptExtend}
          onCheckedChange={(checked) => onChange({ ...params, promptExtend: checked })}
        />
      </div>
      
      <div className="control-group flex items-center justify-between">
        <Label>添加水印</Label>
        <Switch
          checked={params.watermark}
          onCheckedChange={(checked) => onChange({ ...params, watermark: checked })}
        />
      </div>
      
      {renderModelSpecificControls()}
    </div>
  );
}
```

## 4. 状态管理设计

### 4.1 Zustand Store 扩展
```typescript
// stores/bailianSlice.ts
import { create } from 'zustand';
import { devtools } from 'zustand/middleware';

interface BailianParams {
  model: string;
  size: string;
  n: number;
  prompt: string;
  negativePrompt: string;
  promptExtend: boolean;
  watermark: boolean;
  // 特定模型参数
  [key: string]: any;
}

interface BailianState {
  prompt: string;
  bailianParams: BailianParams;
  isGenerating: boolean;
  generatedImages: string[];
  taskId: string | null;
  setPrompt: (prompt: string) => void;
  setBailianParams: (params: BailianParams) => void;
  generateImage: () => Promise<void>;
  checkTaskStatus: () => Promise<void>;
}

export const useBailianStore = create<BailianState>()(
  devtools((set, get) => ({
    prompt: '',
    bailianParams: {
      model: 'wan2.2-t2i-plus',
      size: '1024*1024',
      n: 1,
      prompt: '',
      negativePrompt: '',
      promptExtend: false,
      watermark: false,
    },
    isGenerating: false,
    generatedImages: [],
    taskId: null,
    
    setPrompt: (prompt) => set({ prompt }),
    
    setBailianParams: (params) => set({ bailianParams: params }),
    
    generateImage: async () => {
      const { prompt, bailianParams } = get();
      if (!prompt) return;
      
      set({ isGenerating: true });
      
      try {
        const result = await bailianGenerateImage({
          prompt,
          ...bailianParams
        });
        
        set({ 
          taskId: result.taskId || null,
          isGenerating: false 
        });
        
        // 如果有任务ID，开始轮询任务状态
        if (result.taskId) {
          const checkStatus = async () => {
            const status = await getBailianTaskStatus(result.taskId!);
            if (status.taskStatus === 'SUCCEEDED' && status.results) {
              const imageUrls = status.results.map(r => r.url);
              set({ generatedImages: imageUrls });
            } else if (status.taskStatus === 'FAILED') {
              throw new Error('图像生成失败');
            } else {
              // 继续轮询
              setTimeout(checkStatus, 5000);
            }
          };
          
          setTimeout(checkStatus, 5000);
        } else if (result.imageUrls) {
          // 如果直接返回了图像URLs
          set({ generatedImages: result.imageUrls });
        }
      } catch (error) {
        set({ isGenerating: false });
        throw error;
      }
    },
    
    checkTaskStatus: async () => {
      const { taskId } = get();
      if (!taskId) return;
      
      try {
        const status = await getBailianTaskStatus(taskId);
        if (status.taskStatus === 'SUCCEEDED' && status.results) {
          const imageUrls = status.results.map(r => r.url);
          set({ generatedImages: imageUrls });
        }
      } catch (error) {
        throw error;
      }
    }
  }))
);
```

## 5. UI/UX 设计

### 5.1 界面布局
```
+-----------------------------------------------------+
| 阿里云百炼图像处理                                   |
+----------------------+-----------------------------+
| 控制面板             | 预览区域                    |
|                      |                             |
| [选择模型 ▼]         | [提示词输入框]              |
| [分辨率: 1024*1024]  |                             |
| [生成数量: 1 ----o]  | [生成按钮]                  |
| [反向提示词输入框]   |                             |
| [√] 智能改写         | [生成中的图像占位符]        |
| [ ] 添加水印         |                             |
| [特定模型参数控件]    |                             |
|                      |                             |
+----------------------+-----------------------------+
```

### 5.2 交互流程
1. 用户选择阿里云百炼模型
2. 用户输入提示词和反向提示词
3. 用户调整参数设置
4. 点击"生成图像"按钮
5. 显示任务提交状态和轮询进度
6. 任务完成后展示生成的图像
7. 提供下载和继续编辑选项

## 6. 开发计划

### 6.1 第一阶段：基础框架搭建 (1周)
- [ ] 创建组件结构和文件
- [ ] 实现 Zustand 状态管理
- [ ] 设计 UI 组件
- [ ] 实现基础 API 调用

### 6.2 第二阶段：核心功能开发 (2周)
- [ ] 实现文生图功能
- [ ] 实现图像编辑功能
- [ ] 实现任务状态轮询机制
- [ ] 实现参数配置功能

### 6.3 第三阶段：增强功能开发 (2周)
- [ ] 实现风格重绘功能
- [ ] 实现背景生成功能
- [ ] 实现图像扩图功能
- [ ] 实现虚拟模特生成功能

### 6.4 第四阶段：完整功能开发 (2周)
- [ ] 实现鞋靴试穿功能
- [ ] 实现创意海报生成功能
- [ ] 实现实例分割功能
- [ ] 实现图像擦除补全功能

### 6.5 第五阶段：高级功能开发 (1周)
- [ ] 实现局部重绘功能
- [ ] 实现涂鸦作画功能
- [ ] 添加错误处理机制

### 6.6 第六阶段：测试与优化 (1周)
- [ ] 功能测试
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 文档完善

## 7. 测试方案

### 7.1 单元测试
- 测试状态管理功能
- 测试参数验证逻辑
- 测试API调用函数

### 7.2 集成测试
- 测试完整的图像处理流程
- 测试不同模型的兼容性
- 测试边界条件处理

### 7.3 用户验收测试
- 邀请用户测试生成效果
- 收集用户反馈
- 优化用户体验

## 8. 部署与维护

### 8.1 部署要求
- 确保阿里云API密钥配置正确
- 验证图像生成和下载功能
- 测试不同浏览器兼容性

### 8.2 维护计划
- 定期更新支持的模型列表
- 监控API调用情况
- 收集用户反馈并持续优化

## 9. 风险评估与应对

### 9.1 技术风险
- **API稳定性**: 依赖阿里云API可能存在不稳定因素
  - 应对措施: 实现错误重试机制和降级方案

- **处理性能问题**: 图像处理可能需要较长时间
  - 应对措施: 实现进度指示和后台处理能力

### 9.2 用户体验风险
- **生成时间过长**: AI处理可能需要数分钟
  - 应对措施: 提供进度指示和任务状态查询

## 10. 阿里云百炼API集成细节

### 10.1 认证方式
阿里云百炼API使用API Key进行身份认证，需要在请求头中添加:
```
Authorization: Bearer YOUR_API_KEY
X-DashScope-Async: enable (对于异步接口)
```

### 10.2 请求地址
- 北京地域: `https://dashscope.aliyuncs.com/api/v1`
- 新加坡地域: `https://dashscope-intl.aliyuncs.com/api/v1`

### 10.3 任务状态查询
任务创建后需要通过任务ID轮询查询状态:
- 北京地域: `https://dashscope.aliyuncs.com/api/v1/tasks/{task_id}`
- 新加坡地域: `https://dashscope-intl.aliyuncs.com/api/v1/tasks/{task_id}`

### 10.4 支持的模型
1. `qwen-image-plus` - 通义千问Qwen-Image Plus
2. `wan2.2-t2i-plus` - 通义万相 Wan 2.2 Plus
3. `wan2.2-t2i-flash` - 通义万相 Wan 2.2 Flash
4. `wanx2.1-t2i-turbo` - 通义万相 Wan 2.1 Turbo
5. `wanx2.1-t2i-plus` - 通义万相 Wan 2.1 Plus
6. `qwen-image-edit` - 通义千问Qwen-Image-Edit
7. `wanx-style-repaint-v1` - 通义万相风格重绘
8. `wanx-background-generation-v2` - 通义万相背景生成
9. `image-out-painting` - 图像扩图
10. `virtualmodel-v2` - 虚拟模特V2
11. `shoemodel-v1` - 鞋靴试穿
12. `wanx-poster-generation-v1` - 创意海报生成
13. `image-instance-segmentation` - 实例分割
14. `image-erase-completion` - 图像擦除补全
15. `wanx-x-painting` - 局部重绘
16. `wanx-sketch-to-image-lite` - 涂鸦作画