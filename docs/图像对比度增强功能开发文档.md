# 图像对比度增强功能开发文档

## 1. 功能概述

### 1.1 功能名称
图像对比度增强 (Image Contrast Enhancement)

### 1.2 功能描述
图像对比度增强功能通过AI算法智能调整图像的明暗对比关系，使图像的亮部更亮、暗部更暗，从而增强图像的视觉冲击力和层次感。该功能支持自动和手动两种模式，能够有效改善曝光不足或过度的照片，提升图像的整体视觉效果。

### 1.3 目标用户
- 摄影师和图像处理专业人士
- 社交媒体内容创作者
- 需要优化图像视觉效果的普通用户
- 电商产品图片处理人员

## 2. 功能需求

### 2.1 核心功能
1. **智能对比度分析**：自动分析图像的对比度分布
2. **对比度增强算法**：采用AI算法增强图像对比度
3. **亮度调节**：支持图像整体亮度调节
4. **阴影/高光控制**：分别调节阴影和高光区域
5. **饱和度调节**：增强或减弱颜色饱和度
6. **实时预览**：支持处理过程中的实时预览

### 2.2 用户界面需求
1. 图片上传区域
2. 对比度分析显示
3. 参数调节滑块（对比度、亮度、阴影、高光、饱和度）
4. 实时预览窗口
5. 前后对比视图
6. 预设效果选择器

## 3. 技术实现方案

### 3.1 技术架构
```
前端组件层:
- ContrastEnhancer.tsx (主组件)
- ContrastAnalyzer.tsx (对比度分析器)
- EnhancementControls.tsx (增强控制面板)
- ContrastPreview.tsx (预览组件)
- PresetSelector.tsx (预设选择器)

状态管理层:
- Zustand store (扩展现有状态)
- contrastSlice.ts (对比度增强功能状态)

API层:
- lib/api.ts (新增对比度增强API调用)
- utils/ContrastEnhancement.ts (对比度增强工具)

类型定义层:
- types/index.ts (新增类型定义)
```

### 3.2 API接口设计
```typescript
// 图像对比度增强API接口
interface ContrastEnhancementAction {
  imageSrc: string;
  contrast: number; // 对比度 -100 to 100
  brightness: number; // 亮度 -100 to 100
  shadows: number; // 阴影 -100 to 100
  highlights: number; // 高光 -100 to 100
  saturation: number; // 饱和度 -100 to 100
  autoEnhance: boolean; // 是否自动增强
  enhancementStrength: number; // 自动增强强度 0-100
  outputFormat?: 'png' | 'jpg' | 'webp';
}

interface ContrastAnalysis {
  currentContrast: number; // 当前对比度
  recommendedContrast: number; // 推荐对比度
  histogram: number[]; // 直方图数据
  exposureIssues: 'underexposed' | 'overexposed' | 'normal' | 'mixed';
}

interface ContrastEnhancementResult {
  imageSrc: string;
  contrastAnalysis: ContrastAnalysis;
  processingTime: number; // 处理时间(ms)
  adjustmentsApplied: {
    contrast: number;
    brightness: number;
    shadows: number;
    highlights: number;
    saturation: number;
  };
}

// 主要API函数
export async function enhanceContrast(action: ContrastEnhancementAction): Promise<ContrastEnhancementResult> {
  // 实现图像对比度增强逻辑
}
```

### 3.3 组件设计

#### 3.3.1 主组件 ContrastEnhancer.tsx
```tsx
import React from 'react';
import { ContrastAnalyzer } from './ContrastAnalyzer';
import { EnhancementControls } from './EnhancementControls';
import { ContrastPreview } from './ContrastPreview';
import { PresetSelector } from './PresetSelector';
import { useContrastStore } from '@/stores/contrastSlice';

export function ContrastEnhancer() {
  const { 
    originalImage, 
    enhancedImage, 
    contrastParams,
    contrastAnalysis,
    setContrastParams,
    enhanceContrast,
    analyzeContrast
  } = useContrastStore();

  React.useEffect(() => {
    if (originalImage) {
      analyzeContrast(originalImage);
    }
  }, [originalImage, analyzeContrast]);

  return (
    <div className="contrast-enhancer-container">
      <div className="enhancer-header">
        <h2>图像对比度增强</h2>
        <p>智能增强图像对比度，提升视觉冲击力</p>
      </div>
      
      <div className="enhancer-content">
        <div className="enhancer-sidebar">
          <ContrastAnalyzer 
            contrastAnalysis={contrastAnalysis}
            onAnalyze={() => originalImage && analyzeContrast(originalImage)}
          />
          
          <PresetSelector 
            onSelectPreset={(preset) => setContrastParams({ 
              ...contrastParams, 
              ...preset 
            })}
          />
          
          <EnhancementControls 
            params={contrastParams}
            onChange={setContrastParams}
            onEnhance={enhanceContrast}
          />
        </div>
        
        <div className="enhancer-main">
          <ContrastPreview 
            original={originalImage}
            enhanced={enhancedImage}
            contrastAnalysis={contrastAnalysis}
          />
        </div>
      </div>
    </div>
  );
}
```

#### 3.3.2 增强控制面板 EnhancementControls.tsx
```tsx
import React from 'react';

interface EnhancementControlsProps {
  params: any;
  onChange: (params: any) => void;
  onEnhance: () => void;
}

export function EnhancementControls({ params, onChange, onEnhance }: EnhancementControlsProps) {
  const sliders = [
    { key: 'contrast', label: '对比度', min: -100, max: 100 },
    { key: 'brightness', label: '亮度', min: -100, max: 100 },
    { key: 'shadows', label: '阴影', min: -100, max: 100 },
    { key: 'highlights', label: '高光', min: -100, max: 100 },
    { key: 'saturation', label: '饱和度', min: -100, max: 100 }
  ];

  return (
    <div className="enhancement-controls">
      <h3>增强参数</h3>
      
      <div className="auto-enhance">
        <label>
          <input
            type="checkbox"
            checked={params.autoEnhance}
            onChange={(e) => onChange({ 
              ...params, 
              autoEnhance: e.target.checked 
            })}
          />
          自动增强
        </label>
        
        {params.autoEnhance && (
          <div className="auto-strength">
            <label>增强强度: {params.enhancementStrength}%</label>
            <input
              type="range"
              min="0"
              max="100"
              value={params.enhancementStrength}
              onChange={(e) => onChange({ 
                ...params, 
                enhancementStrength: parseInt(e.target.value) 
              })}
            />
          </div>
        )}
      </div>
      
      {sliders.map((slider) => (
        <div key={slider.key} className="control-group">
          <label>{slider.label}: {params[slider.key]}</label>
          <input
            type="range"
            min={slider.min}
            max={slider.max}
            value={params[slider.key]}
            onChange={(e) => onChange({ 
              ...params, 
              [slider.key]: parseInt(e.target.value) 
            })}
          />
        </div>
      ))}
      
      <button className="enhance-button" onClick={onEnhance}>
        应用增强
      </button>
    </div>
  );
}
```

## 4. 状态管理设计

### 4.1 Zustand Store 扩展
```typescript
// stores/contrastSlice.ts
import { create } from 'zustand';
import { devtools } from 'zustand/middleware';

interface ContrastParameters {
  contrast: number;
  brightness: number;
  shadows: number;
  highlights: number;
  saturation: number;
  autoEnhance: boolean;
  enhancementStrength: number;
}

interface ContrastAnalysis {
  currentContrast: number;
  recommendedContrast: number;
  histogram: number[];
  exposureIssues: 'underexposed' | 'overexposed' | 'normal' | 'mixed';
}

interface ContrastState {
  originalImage: string | null;
  enhancedImage: string | null;
  contrastParams: ContrastParameters;
  contrastAnalysis: ContrastAnalysis | null;
  isProcessing: boolean;
  setOriginalImage: (image: string) => void;
  setContrastParams: (params: ContrastParameters) => void;
  enhanceContrast: () => Promise<void>;
  analyzeContrast: (image: string) => Promise<void>;
}

export const useContrastStore = create<ContrastState>()(
  devtools((set, get) => ({
    originalImage: null,
    enhancedImage: null,
    contrastParams: {
      contrast: 0,
      brightness: 0,
      shadows: 0,
      highlights: 0,
      saturation: 0,
      autoEnhance: true,
      enhancementStrength: 50
    },
    contrastAnalysis: null,
    isProcessing: false,
    
    setOriginalImage: (image) => set({ originalImage: image }),
    
    setContrastParams: (params) => set({ contrastParams: params }),
    
    enhanceContrast: async () => {
      const { originalImage, contrastParams } = get();
      if (!originalImage) return;
      
      set({ isProcessing: true });
      
      try {
        const result = await enhanceContrast({
          imageSrc: originalImage,
          ...contrastParams
        });
        
        set({ 
          enhancedImage: result.imageSrc,
          contrastAnalysis: result.contrastAnalysis,
          isProcessing: false 
        });
      } catch (error) {
        set({ isProcessing: false });
        throw error;
      }
    },
    
    analyzeContrast: async (image: string) => {
      // 实现对比度分析逻辑
      // 这里可以调用专门的API来分析图像对比度
      console.log('Analyzing contrast for image:', image);
      
      // 模拟分析结果
      const analysis: ContrastAnalysis = {
        currentContrast: Math.floor(Math.random() * 100) - 50,
        recommendedContrast: Math.floor(Math.random() * 40) - 20,
        histogram: Array(256).fill(0).map(() => Math.floor(Math.random() * 1000)),
        exposureIssues: 'normal'
      };
      
      set({ contrastAnalysis: analysis });
    }
  }))
);
```

## 5. UI/UX 设计

### 5.1 界面布局
```
+---------------------------------------------------------------+
| 图像对比度增强                                                |
+-------------------+-------------------------------------------+
| 控制面板          | 预览区域                                  |
|                   |                                           |
| 对比度分析:       | [原始图片]        [增强后图片]            |
| 当前: 15          |                                           |
| 推荐: 25          |                                           |
| 曝光: 正常        |                                           |
|                   |                                           |
| 预设效果:         |                                           |
| [风景] [人像] [夜景] [自动]                                   |
|                   |                                           |
| [√] 自动增强      |                                           |
| 强度: 50%         |                                           |
| [----o----]       |                                           |
|                   |                                           |
| 对比度: 0         |                                           |
| [--o--]           |                                           |
| 亮度: 0           |                                           |
| [--o--]           |                                           |
| 阴影: 0           |                                           |
| [--o--]           |                                           |
| 高光: 0           |                                           |
| [--o--]           |                                           |
| 饱和度: 0         |                                           |
| [--o--]           |                                           |
|                   |                                           |
| [应用增强]        |                                           |
+-------------------+-------------------------------------------+
```

### 5.2 交互流程
1. 用户上传需要增强对比度的图片
2. 系统自动分析图像对比度分布
3. 显示对比度分析结果和推荐参数
4. 用户选择预设效果或手动调整参数
5. 实时预览增强效果
6. 点击"应用增强"按钮
7. 显示处理进度
8. 展示增强后的图片
9. 提供下载和继续编辑选项

## 6. 开发计划

### 6.1 第一阶段：基础框架搭建 (1周)
- [ ] 创建组件结构和文件
- [ ] 实现 Zustand 状态管理
- [ ] 设计 UI 组件
- [ ] 实现图片上传功能

### 6.2 第二阶段：核心功能开发 (2周)
- [ ] 实现对比度分析功能
- [ ] 实现基础增强算法
- [ ] 实现参数调节功能
- [ ] 实现预设效果功能

### 6.3 第三阶段：增强功能开发 (1周)
- [ ] 添加实时预览功能
- [ ] 优化处理性能
- [ ] 添加直方图显示

### 6.4 第四阶段：测试与优化 (1周)
- [ ] 功能测试
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 文档完善

## 7. 测试方案

### 7.1 单元测试
- 测试状态管理功能
- 测试对比度分析准确性
- 测试参数调节逻辑

### 7.2 集成测试
- 测试完整的增强流程
- 测试不同预设效果
- 测试边界条件处理

### 7.3 用户验收测试
- 邀请摄影师测试效果
- 收集用户反馈
- 优化用户体验

## 8. 部署与维护

### 8.1 部署要求
- 确保302.AI API密钥配置正确
- 验证图像上传和处理功能
- 测试不同浏览器兼容性

### 8.2 维护计划
- 定期更新AI模型
- 监控API调用情况
- 收集用户反馈并持续优化