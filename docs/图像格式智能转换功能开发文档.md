# 图像格式智能转换功能开发文档

## 1. 功能概述

### 1.1 功能名称
图像格式智能转换 (Intelligent Image Format Conversion)

### 1.2 功能描述
图像格式智能转换功能能够根据图片内容和用途自动推荐最佳的图像格式和参数设置，并支持批量转换。该功能提供多种格式选项、质量调节、尺寸优化等特性，帮助用户在保持视觉质量的同时优化文件大小。

### 1.3 目标用户
- 网站开发者和设计师
- 电商产品图片管理人员
- 社交媒体内容创作者
- 需要优化图片文件大小的普通用户

## 2. 功能需求

### 2.1 核心功能
1. **智能格式推荐**：根据图片内容自动推荐最佳格式
2. **多种格式支持**：支持JPG、PNG、WebP、AVIF等主流格式
3. **质量调节**：支持0-100%质量调节
4. **尺寸优化**：支持自动或手动调整图片尺寸
5. **文件大小预估**：预估转换后的文件大小
6. **批量处理**：支持多张图片同时转换

### 2.2 用户界面需求
1. 图片上传区域
2. 格式选择器
3. 质量调节滑块
4. 尺寸设置面板
5. 预览窗口
6. 文件大小预估显示
7. 批量处理选项

## 3. 技术实现方案

### 3.1 技术架构
```
前端组件层:
- FormatConverter.tsx (主组件)
- FormatSelector.tsx (格式选择器)
- QualitySlider.tsx (质量调节器)
- SizeSettings.tsx (尺寸设置器)
- FormatPreview.tsx (预览组件)
- SizeEstimator.tsx (大小预估器)

状态管理层:
- Zustand store (扩展现有状态)
- formatSlice.ts (格式转换功能状态)

API层:
- lib/api.ts (新增格式转换API调用)
- utils/FormatConverter.ts (格式转换工具)

类型定义层:
- types/index.ts (新增类型定义)
```

### 3.2 API接口设计
```typescript
// 图像格式智能转换API接口
interface FormatConversionAction {
  imageSrc: string;
  targetFormat: 'jpg' | 'png' | 'webp' | 'avif' | 'auto';
  quality: number; // 0-100
  resize?: {
    width?: number;
    height?: number;
    mode: 'fit' | 'fill' | 'stretch';
  };
  compression: 'lossy' | 'lossless' | 'auto';
  optimizeFor: 'web' | 'print' | 'storage' | 'auto';
  outputFileName?: string;
}

interface FormatConversionResult {
  imageSrc: string;
  originalInfo: {
    format: string;
    size: { width: number; height: number };
    fileSize: number;
  };
  convertedInfo: {
    format: string;
    size: { width: number; height: number };
    fileSize: number;
    estimatedFileSize: number;
  };
  processingTime: number; // 处理时间(ms)
  savings: number; // 节省的百分比
}

// 主要API函数
export async function convertImageFormat(action: FormatConversionAction): Promise<FormatConversionResult> {
  // 实现图像格式转换逻辑
}
```

### 3.3 组件设计

#### 3.3.1 主组件 FormatConverter.tsx
```tsx
import React from 'react';
import { FormatSelector } from './FormatSelector';
import { QualitySlider } from './QualitySlider';
import { SizeSettings } from './SizeSettings';
import { FormatPreview } from './FormatPreview';
import { SizeEstimator } from './SizeEstimator';
import { useFormatStore } from '@/stores/formatSlice';

export function FormatConverter() {
  const { 
    originalImage, 
    convertedImage, 
    formatParams,
    originalInfo,
    convertedInfo,
    setFormatParams,
    convertImageFormat,
    isProcessing
  } = useFormatStore();

  return (
    <div className="format-converter-container">
      <div className="converter-header">
        <h2>图像格式智能转换</h2>
        <p>智能推荐最佳图像格式，优化文件大小和质量</p>
      </div>
      
      <div className="converter-content">
        <div className="converter-sidebar">
          <FormatSelector 
            selectedFormat={formatParams.targetFormat}
            onSelectFormat={(format) => setFormatParams({ 
              ...formatParams, 
              targetFormat: format 
            })}
          />
          
          <QualitySlider 
            quality={formatParams.quality}
            onQualityChange={(quality) => setFormatParams({ 
              ...formatParams, 
              quality 
            })}
          />
          
          <SizeSettings 
            resize={formatParams.resize}
            onResizeChange={(resize) => setFormatParams({ 
              ...formatParams, 
              resize 
            })}
          />
        </div>
        
        <div className="converter-main">
          <FormatPreview 
            original={originalImage}
            converted={convertedImage}
            originalInfo={originalInfo}
            convertedInfo={convertedInfo}
            isProcessing={isProcessing}
          />
        </div>
        
        <div className="converter-info">
          <SizeEstimator 
            originalInfo={originalInfo}
            convertedInfo={convertedInfo}
            formatParams={formatParams}
          />
          
          <div className="optimize-options">
            <h3>优化目标</h3>
            <div className="radio-group">
              <label>
                <input
                  type="radio"
                  name="optimizeFor"
                  value="auto"
                  checked={formatParams.optimizeFor === 'auto'}
                  onChange={() => setFormatParams({ 
                    ...formatParams, 
                    optimizeFor: 'auto' 
                  })}
                />
                自动推荐
              </label>
              <label>
                <input
                  type="radio"
                  name="optimizeFor"
                  value="web"
                  checked={formatParams.optimizeFor === 'web'}
                  onChange={() => setFormatParams({ 
                    ...formatParams, 
                    optimizeFor: 'web' 
                  })}
                />
                网页显示
              </label>
              <label>
                <input
                  type="radio"
                  name="optimizeFor"
                  value="storage"
                  checked={formatParams.optimizeFor === 'storage'}
                  onChange={() => setFormatParams({ 
                    ...formatParams, 
                    optimizeFor: 'storage' 
                  })}
                />
                存储优化
              </label>
              <label>
                <input
                  type="radio"
                  name="optimizeFor"
                  value="print"
                  checked={formatParams.optimizeFor === 'print'}
                  onChange={() => setFormatParams({ 
                    ...formatParams, 
                    optimizeFor: 'print' 
                  })}
                />
                打印质量
              </label>
            </div>
          </div>
        </div>
      </div>
      
      <div className="converter-footer">
        <button 
          className="convert-button"
          disabled={!originalImage || isProcessing}
          onClick={convertImageFormat}
        >
          {isProcessing ? '转换中...' : '开始转换'}
        </button>
        
        {convertedImage && (
          <div className="action-buttons">
            <button className="download-button" onClick={() => {
              // 下载逻辑
            }}>
              下载转换结果
            </button>
            
            <button className="batch-button" onClick={() => {
              // 批量处理逻辑
            }}>
              批量转换
            </button>
          </div>
        )}
      </div>
    </div>
  );
}
```

#### 3.3.2 格式选择器 FormatSelector.tsx
```tsx
import React from 'react';

interface FormatOption {
  value: 'jpg' | 'png' | 'webp' | 'avif' | 'auto';
  label: string;
  description: string;
  icon: string;
}

const FORMAT_OPTIONS: FormatOption[] = [
  {
    value: 'auto',
    label: '自动推荐',
    description: '根据图片内容智能推荐最佳格式',
    icon: '🤖'
  },
  {
    value: 'jpg',
    label: 'JPG',
    description: '适用于照片，文件较小',
    icon: '🖼️'
  },
  {
    value: 'png',
    label: 'PNG',
    description: '支持透明背景，无损压缩',
    icon: '透明'
  },
  {
    value: 'webp',
    label: 'WebP',
    description: '现代格式，更小文件大小',
    icon: '🌐'
  },
  {
    value: 'avif',
    label: 'AVIF',
    description: '最新格式，最佳压缩效果',
    icon: '⚡'
  }
];

interface FormatSelectorProps {
  selectedFormat: 'jpg' | 'png' | 'webp' | 'avif' | 'auto';
  onSelectFormat: (format: 'jpg' | 'png' | 'webp' | 'avif' | 'auto') => void;
}

export function FormatSelector({ selectedFormat, onSelectFormat }: FormatSelectorProps) {
  return (
    <div className="format-selector">
      <h3>目标格式</h3>
      <div className="format-options">
        {FORMAT_OPTIONS.map((option) => (
          <div 
            key={option.value}
            className={`format-option ${selectedFormat === option.value ? 'selected' : ''}`}
            onClick={() => onSelectFormat(option.value)}
          >
            <div className="format-icon">{option.icon}</div>
            <div className="format-info">
              <h4>{option.label}</h4>
              <p>{option.description}</p>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}
```

## 4. 状态管理设计

### 4.1 Zustand Store 扩展
```typescript
// stores/formatSlice.ts
import { create } from 'zustand';
import { devtools } from 'zustand/middleware';

interface ResizeParams {
  width?: number;
  height?: number;
  mode: 'fit' | 'fill' | 'stretch';
}

interface FormatParams {
  targetFormat: 'jpg' | 'png' | 'webp' | 'avif' | 'auto';
  quality: number;
  resize?: ResizeParams;
  compression: 'lossy' | 'lossless' | 'auto';
  optimizeFor: 'web' | 'print' | 'storage' | 'auto';
}

interface ImageInfo {
  format: string;
  size: { width: number; height: number };
  fileSize: number;
}

interface FormatState {
  originalImage: string | null;
  convertedImage: string | null;
  formatParams: FormatParams;
  originalInfo: ImageInfo | null;
  convertedInfo: ImageInfo | null;
  isProcessing: boolean;
  setOriginalImage: (image: string) => void;
  setFormatParams: (params: FormatParams) => void;
  convertImageFormat: () => Promise<void>;
}

export const useFormatStore = create<FormatState>()(
  devtools((set, get) => ({
    originalImage: null,
    convertedImage: null,
    formatParams: {
      targetFormat: 'auto',
      quality: 80,
      compression: 'auto',
      optimizeFor: 'auto'
    },
    originalInfo: null,
    convertedInfo: null,
    isProcessing: false,
    
    setOriginalImage: (image) => set({ originalImage: image }),
    
    setFormatParams: (params) => set({ formatParams: params }),
    
    convertImageFormat: async () => {
      const { originalImage, formatParams } = get();
      if (!originalImage) return;
      
      set({ isProcessing: true });
      
      try {
        const result = await convertImageFormat({
          imageSrc: originalImage,
          ...formatParams
        });
        
        set({ 
          convertedImage: result.imageSrc,
          originalInfo: result.originalInfo,
          convertedInfo: result.convertedInfo,
          isProcessing: false 
        });
      } catch (error) {
        set({ isProcessing: false });
        throw error;
      }
    }
  }))
);
```

## 5. UI/UX 设计

### 5.1 界面布局
```
+---------------------------------------------------------------+
| 图像格式智能转换工具                                          |
+-----------+----------------------+---------------------------+
| 设置面板  | 预览区域             | 信息面板                  |
|           |                      |                           |
| [自动推荐] | [图片预览区域]       | 原始文件:                |
| [JPG]     |                      | 格式: JPG                |
| [PNG]     |                      | 尺寸: 1920x1080          |
| [WebP]    |                      | 大小: 2.4MB              |
| [AVIF]    |                      |                           |
|           |                      | 转换后:                  |
| 质量: 80% |                      | 格式: WebP               |
| [----o----] |                      | 尺寸: 1920x1080          |
|           |                      | 大小: 1.1MB              |
| 尺寸设置  |                      | 节省: 54%                |
| 宽度: 1920|                      |                           |
| 高度: 1080|                      | 优化目标:                |
+-----------+----------------------+ [○]自动推荐               |
| [开始转换] [下载结果] [批量转换] | [●]网页显示               |
|                                  | [○]存储优化               |
|                                  | [○]打印质量               |
+---------------------------------------------------------------+
```

### 5.2 交互流程
1. 用户上传需要转换格式的图片
2. 选择目标格式或使用自动推荐
3. 调整质量参数和尺寸设置
4. 选择优化目标（网页显示/存储优化/打印质量）
5. 实时预览转换效果和文件大小预估
6. 点击"开始转换"按钮
7. 显示处理进度
8. 展示转换后的图片和文件信息
9. 提供下载和批量转换选项

## 6. 开发计划

### 6.1 第一阶段：基础框架搭建 (1周)
- [ ] 创建组件结构和文件
- [ ] 实现 Zustand 状态管理
- [ ] 设计 UI 组件
- [ ] 实现图片上传功能

### 6.2 第二阶段：核心功能开发 (2周)
- [ ] 实现基础格式转换功能
- [ ] 实现质量调节功能
- [ ] 实现尺寸调整功能
- [ ] 实现文件大小预估

### 6.3 第三阶段：增强功能开发 (1周)
- [ ] 实现智能格式推荐
- [ ] 添加批量处理功能
- [ ] 实现多种优化目标
- [ ] 优化处理性能

### 6.4 第四阶段：测试与优化 (1周)
- [ ] 功能测试
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 文档完善

## 7. 测试方案

### 7.1 单元测试
- 测试状态管理功能
- 测试格式转换逻辑
- 测试参数验证逻辑

### 7.2 集成测试
- 测试完整的格式转换流程
- 测试不同格式的转换效果
- 测试批量处理功能

### 7.3 用户验收测试
- 邀请开发者测试转换效果
- 收集用户反馈
- 优化用户体验

## 8. 部署与维护

### 8.1 部署要求
- 确保302.AI API密钥配置正确
- 验证图像上传和处理功能
- 测试不同浏览器兼容性

### 8.2 维护计划
- 监控API调用情况
- 收集用户反馈并持续优化
- 定期更新格式转换算法
- 扩展支持的新格式