# 批量图像处理功能开发文档

## 1. 功能概述

### 1.1 功能名称
批量图像处理 (Batch Image Processing)

### 1.2 功能描述
批量图像处理功能允许用户同时处理多张图片，支持多种处理操作的组合应用。该功能提供队列管理、进度跟踪、错误处理和批量导出等特性，大幅提升处理大量图片的效率。

### 1.3 目标用户
- 摄影师和图像处理专业人员
- 电商产品图片处理人员
- 内容创作者
- 需要处理大量图片的普通用户

## 2. 功能需求

### 2.1 核心功能
1. **多图上传**：支持同时上传多张图片
2. **处理队列**：管理图片处理队列和顺序
3. **批量操作**：支持多种处理操作的批量应用
4. **进度跟踪**：实时显示处理进度和状态
5. **错误处理**：处理单张图片失败不影响整体流程
6. **批量导出**：支持打包下载处理结果

### 2.2 用户界面需求
1. 批量上传区域
2. 图片列表和状态显示
3. 处理操作选择面板
4. 批量参数设置
5. 进度条和状态指示器
6. 批量导出功能

## 3. 技术实现方案

### 3.1 技术架构
```
前端组件层:
- BatchProcessor.tsx (主组件)
- ImageUploader.tsx (图片上传器)
- ImageList.tsx (图片列表)
- BatchOperations.tsx (批量操作面板)
- ProgressTracker.tsx (进度跟踪器)
- BatchExporter.tsx (批量导出器)

状态管理层:
- Zustand store (扩展现有状态)
- batchSlice.ts (批量处理功能状态)

API层:
- lib/api.ts (新增批量处理API调用)
- utils/BatchProcessing.ts (批量处理工具)

类型定义层:
- types/index.ts (新增类型定义)
```

### 3.2 API接口设计
```typescript
// 批量图像处理API接口
interface BatchProcessAction {
  images: Array<{
    id: string;
    src: string;
    filename: string;
  }>;
  operations: Array<{
    type: BatchOperationType;
    params: any;
  }>;
  outputSettings: {
    format: 'png' | 'jpg' | 'webp';
    quality: number; // 1-100
    namingPattern: string; // 命名模式
  };
  processingOrder: 'sequential' | 'parallel'; // 处理顺序
}

type BatchOperationType = 
  | 'resize'           // 调整尺寸
  | 'crop'             // 裁剪
  | 'rotate'           // 旋转
  | 'filter'           // 滤镜
  | 'watermark'        // 水印
  | 'compress'         // 压缩
  | 'remove_bg'        // 去除背景
  | 'upscale'          // 放大
  | 'colorize';        // 上色

interface BatchProcessResult {
  results: Array<{
    id: string;
    imageSrc: string;
    filename: string;
    status: 'success' | 'error';
    error?: string;
    processingTime: number;
  }>;
  zipFileUrl?: string; // 打包文件URL
  totalProcessingTime: number;
  successCount: number;
  errorCount: number;
}

// 主要API函数
export async function batchProcess(action: BatchProcessAction): Promise<BatchProcessResult> {
  // 实现批量处理逻辑
}
```

### 3.3 组件设计

#### 3.3.1 主组件 BatchProcessor.tsx
```tsx
import React from 'react';
import { ImageUploader } from './ImageUploader';
import { ImageList } from './ImageList';
import { BatchOperations } from './BatchOperations';
import { ProgressTracker } from './ProgressTracker';
import { BatchExporter } from './BatchExporter';
import { useBatchStore } from '@/stores/batchSlice';

export function BatchProcessor() {
  const { 
    images, 
    batchResults, 
    batchParams,
    processingStatus,
    addImages,
    removeImage,
    setBatchParams,
    batchProcess,
    resetBatch
  } = useBatchStore();

  return (
    <div className="batch-processor-container">
      <div className="batch-header">
        <h2>批量图像处理</h2>
        <p>同时处理多张图片，提升工作效率</p>
      </div>
      
      <div className="batch-content">
        <div className="batch-sidebar">
          <ImageUploader 
            onImagesAdded={addImages}
          />
          
          <BatchOperations 
            operations={batchParams.operations}
            onOperationsChange={(ops) => setBatchParams({ ...batchParams, operations: ops })}
            outputSettings={batchParams.outputSettings}
            onOutputSettingsChange={(settings) => setBatchParams({ 
              ...batchParams, 
              outputSettings: settings 
            })}
          />
        </div>
        
        <div className="batch-main">
          <ImageList 
            images={images}
            results={batchResults}
            onRemoveImage={removeImage}
          />
          
          {processingStatus.isProcessing && (
            <ProgressTracker 
              status={processingStatus}
            />
          )}
          
          {batchResults.length > 0 && !processingStatus.isProcessing && (
            <BatchExporter 
              results={batchResults}
              onReset={resetBatch}
            />
          )}
        </div>
      </div>
      
      <div className="batch-footer">
        <button 
          className="process-button"
          disabled={images.length === 0 || processingStatus.isProcessing}
          onClick={batchProcess}
        >
          开始批量处理
        </button>
        
        <button 
          className="reset-button"
          onClick={resetBatch}
        >
          重置
        </button>
      </div>
    </div>
  );
}
```

#### 3.3.2 图片列表 ImageList.tsx
```tsx
import React from 'react';
import { BatchImage, BatchResult } from '@/types';

interface ImageListProps {
  images: BatchImage[];
  results: BatchResult[];
  onRemoveImage: (imageId: string) => void;
}

export function ImageList({ images, results, onRemoveImage }: ImageListProps) {
  return (
    <div className="image-list">
      <h3>待处理图片 ({images.length}张)</h3>
      <div className="image-grid">
        {images.map((image) => {
          const result = results.find(r => r.id === image.id);
          return (
            <div key={image.id} className="image-item">
              <div className="image-preview">
                <img src={image.src} alt={image.filename} />
              </div>
              <div className="image-info">
                <div className="filename">{image.filename}</div>
                <div className="status">
                  {result ? (
                    <span className={`status-${result.status}`}>
                      {result.status === 'success' ? '✓ 处理完成' : `✗ ${result.error}`}
                    </span>
                  ) : (
                    <span className="status-pending">等待处理</span>
                  )}
                </div>
              </div>
              <button 
                className="remove-button"
                onClick={() => onRemoveImage(image.id)}
              >
                ×
              </button>
            </div>
          );
        })}
      </div>
    </div>
  );
}
```

## 4. 状态管理设计

### 4.1 Zustand Store 扩展
```typescript
// stores/batchSlice.ts
import { create } from 'zustand';
import { devtools } from 'zustand/middleware';
import { BatchOperationType } from '@/types';

interface BatchImage {
  id: string;
  src: string;
  filename: string;
  size?: number;
}

interface BatchOperation {
  type: BatchOperationType;
  params: any;
}

interface OutputSettings {
  format: 'png' | 'jpg' | 'webp';
  quality: number;
  namingPattern: string;
}

interface BatchParams {
  operations: BatchOperation[];
  outputSettings: OutputSettings;
  processingOrder: 'sequential' | 'parallel';
}

interface ProcessingStatus {
  isProcessing: boolean;
  currentImage?: string;
  progress: number;
  total: number;
}

interface BatchResult {
  id: string;
  imageSrc: string;
  filename: string;
  status: 'success' | 'error';
  error?: string;
  processingTime: number;
}

interface BatchState {
  images: BatchImage[];
  batchResults: BatchResult[];
  batchParams: BatchParams;
  processingStatus: ProcessingStatus;
  addImages: (images: Omit<BatchImage, 'id'>[]) => void;
  removeImage: (imageId: string) => void;
  setBatchParams: (params: BatchParams) => void;
  batchProcess: () => Promise<void>;
  resetBatch: () => void;
}

export const useBatchStore = create<BatchState>()(
  devtools((set, get) => ({
    images: [],
    batchResults: [],
    batchParams: {
      operations: [],
      outputSettings: {
        format: 'jpg',
        quality: 80,
        namingPattern: 'processed_{original}'
      },
      processingOrder: 'parallel'
    },
    processingStatus: {
      isProcessing: false,
      progress: 0,
      total: 0
    },
    
    addImages: (newImages) => {
      const imagesWithId = newImages.map(img => ({
        ...img,
        id: Math.random().toString(36).substr(2, 9)
      }));
      set((state) => ({
        images: [...state.images, ...imagesWithId]
      }));
    },
    
    removeImage: (imageId) => {
      set((state) => ({
        images: state.images.filter(img => img.id !== imageId)
      }));
    },
    
    setBatchParams: (params) => set({ batchParams: params }),
    
    batchProcess: async () => {
      const { images, batchParams } = get();
      if (images.length === 0) return;
      
      set({ 
        processingStatus: {
          isProcessing: true,
          progress: 0,
          total: images.length
        }
      });
      
      try {
        const result = await batchProcess({
          images: images.map(img => ({
            id: img.id,
            src: img.src,
            filename: img.filename
          })),
          ...batchParams
        });
        
        set({ 
          batchResults: result.results,
          processingStatus: {
            isProcessing: false,
            progress: result.successCount + result.errorCount,
            total: images.length
          }
        });
      } catch (error) {
        set({ 
          processingStatus: {
            isProcessing: false,
            progress: 0,
            total: 0
          }
        });
        throw error;
      }
    },
    
    resetBatch: () => {
      set({ 
        images: [],
        batchResults: [],
        processingStatus: {
          isProcessing: false,
          progress: 0,
          total: 0
        }
      });
    }
  }))
);
```

## 5. UI/UX 设计

### 5.1 界面布局
```
+---------------------------------------------------------------+
| 批量图像处理工具                                              |
+-----------+---------------------------------------------------+
| 操作面板  | 图片列表区域                                          |
|           |                                                   |
| [上传图片] | [图片1.jpg] [图片2.jpg] [图片3.jpg] ...          |
|           |  ✓ 处理完成   ✗ 处理失败   等待处理                 |
| 处理操作  |                                                   |
| [调整尺寸] |                                                   |
| [裁剪]    |                                                   |
| [滤镜]    |                                                   |
| [水印]    |                                                   |
|           |                                                   |
| 输出设置  |                                                   |
| 格式: JPG |                                                   |
| 质量: 80% |                                                   |
+-----------+---------------------------------------------------+
| 处理进度: [██████████████████░░░░░░░░░░] 5/10 (50%)         |
+-----------------------------------------------------------+
| [开始批量处理] [重置] [打包下载]                          |
+---------------------------------------------------------------+
```

### 5.2 交互流程
1. 用户通过拖拽或点击上传多张图片
2. 选择需要应用的处理操作
3. 设置输出参数（格式、质量、命名规则等）
4. 查看图片列表和状态
5. 点击"开始批量处理"按钮
6. 实时查看处理进度
7. 处理完成后显示结果状态
8. 支持打包下载所有处理结果
9. 提供重置功能重新开始

## 6. 开发计划

### 6.1 第一阶段：基础框架搭建 (1周)
- [ ] 创建组件结构和文件
- [ ] 实现 Zustand 状态管理
- [ ] 设计 UI 组件
- [ ] 实现多图上传功能

### 6.2 第二阶段：核心功能开发 (2周)
- [ ] 实现基础批量操作功能
- [ ] 实现处理队列管理
- [ ] 实现进度跟踪功能
- [ ] 实现错误处理机制

### 6.3 第三阶段：增强功能开发 (1周)
- [ ] 实现并行处理优化
- [ ] 添加批量导出功能
- [ ] 实现处理结果预览
- [ ] 优化用户界面体验

### 6.4 第四阶段：测试与优化 (1周)
- [ ] 功能测试
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 文档完善

## 7. 测试方案

### 7.1 单元测试
- 测试状态管理功能
- 测试批量操作逻辑
- 测试错误处理机制

### 7.2 集成测试
- 测试完整的批量处理流程
- 测试不同操作组合的效果
- 测试大文件处理能力

### 7.3 用户验收测试
- 邀请摄影师测试批量处理效果
- 收集用户反馈
- 优化用户体验

## 8. 部署与维护

### 8.1 部署要求
- 确保302.AI API密钥配置正确
- 验证图像上传和处理功能
- 测试不同浏览器兼容性

### 8.2 维护计划
- 监控API调用情况
- 优化处理队列性能
- 收集用户反馈并持续优化