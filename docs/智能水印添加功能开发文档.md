# 智能水印添加功能开发文档

## 1. 功能概述

### 1.1 功能名称
智能水印添加 (Smart Watermark Addition)

### 1.2 功能描述
智能水印添加功能允许用户为图片自动或手动添加水印，包括文字水印和图片水印。该功能提供智能位置识别、透明度调节、大小适配等特性，帮助用户有效保护其作品版权。

### 1.3 目标用户
- 摄影师和设计师
- 内容创作者
- 企业用户
- 需要保护作品版权的普通用户

## 2. 功能需求

### 2.1 核心功能
1. **文字水印**：支持自定义文字、字体、颜色、大小
2. **图片水印**：支持上传自定义图片作为水印
3. **智能位置识别**：自动识别最佳水印位置
4. **透明度调节**：支持水印透明度调节（0-100%）
5. **大小适配**：根据原图大小自动适配水印尺寸
6. **批量处理**：支持多张图片同时添加水印

### 2.2 用户界面需求
1. 水印类型选择器
2. 文字水印设置面板
3. 图片水印上传区域
4. 位置选择器
5. 透明度调节滑块
6. 预览窗口
7. 批量处理选项

## 3. 技术实现方案

### 3.1 技术架构
```
前端组件层:
- SmartWatermark.tsx (主组件)
- WatermarkTypeSelector.tsx (水印类型选择器)
- TextWatermarkPanel.tsx (文字水印面板)
- ImageWatermarkUploader.tsx (图片水印上传器)
- PositionSelector.tsx (位置选择器)
- WatermarkPreview.tsx (预览组件)

状态管理层:
- Zustand store (扩展现有状态)
- watermarkSlice.ts (水印功能状态)

API层:
- lib/api.ts (新增水印API调用)
- utils/Watermark.ts (水印处理工具)

类型定义层:
- types/index.ts (新增类型定义)
```

### 3.2 API接口设计
```typescript
// 智能水印添加API接口
interface SmartWatermarkAction {
  imageSrc: string;
  watermarkType: 'text' | 'image';
  textWatermark?: {
    text: string;
    font: string;
    fontSize: number;
    color: string;
    fontStyle: 'normal' | 'bold' | 'italic';
  };
  imageWatermark?: {
    src: string;
    width?: number;
    height?: number;
  };
  position: {
    x: number | 'auto'; // 0-100 或 auto
    y: number | 'auto'; // 0-100 或 auto
    corner?: 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right' | 'center';
  };
  opacity: number; // 0-100
  scale: number; // 0-100
  rotation: number; // 0-360
  outputFormat?: 'png' | 'jpg' | 'webp';
}

interface SmartWatermarkResult {
  imageSrc: string;
  processingTime: number; // 处理时间(ms)
  watermarkInfo: {
    type: 'text' | 'image';
    position: { x: number; y: number };
    size: { width: number; height: number };
  };
}

// 主要API函数
export async function addSmartWatermark(action: SmartWatermarkAction): Promise<SmartWatermarkResult> {
  // 实现智能水印添加逻辑
}
```

### 3.3 组件设计

#### 3.3.1 主组件 SmartWatermark.tsx
```tsx
import React from 'react';
import { WatermarkTypeSelector } from './WatermarkTypeSelector';
import { TextWatermarkPanel } from './TextWatermarkPanel';
import { ImageWatermarkUploader } from './ImageWatermarkUploader';
import { PositionSelector } from './PositionSelector';
import { WatermarkPreview } from './WatermarkPreview';
import { useWatermarkStore } from '@/stores/watermarkSlice';

export function SmartWatermark() {
  const { 
    originalImage, 
    watermarkedImage, 
    watermarkParams,
    setWatermarkParams,
    addSmartWatermark,
    isProcessing
  } = useWatermarkStore();

  return (
    <div className="smart-watermark-container">
      <div className="watermark-header">
        <h2>智能水印添加</h2>
        <p>为您的图片添加个性化水印，保护作品版权</p>
      </div>
      
      <div className="watermark-content">
        <div className="watermark-sidebar">
          <WatermarkTypeSelector 
            selectedType={watermarkParams.watermarkType}
            onSelectType={(type) => setWatermarkParams({ ...watermarkParams, watermarkType: type })}
          />
          
          {watermarkParams.watermarkType === 'text' ? (
            <TextWatermarkPanel 
              textParams={watermarkParams.textWatermark}
              onChangeText={(textParams) => setWatermarkParams({ 
                ...watermarkParams, 
                textWatermark: textParams 
              })}
            />
          ) : (
            <ImageWatermarkUploader 
              imageParams={watermarkParams.imageWatermark}
              onImageChange={(imageParams) => setWatermarkParams({ 
                ...watermarkParams, 
                imageWatermark: imageParams 
              })}
            />
          )}
          
          <PositionSelector 
            position={watermarkParams.position}
            onPositionChange={(position) => setWatermarkParams({ 
              ...watermarkParams, 
              position 
            })}
          />
        </div>
        
        <div className="watermark-main">
          <WatermarkPreview 
            original={originalImage}
            watermarked={watermarkedImage}
            watermarkParams={watermarkParams}
            isProcessing={isProcessing}
          />
        </div>
        
        <div className="watermark-controls">
          <div className="control-group">
            <label>透明度: {watermarkParams.opacity}%</label>
            <input
              type="range"
              min="0"
              max="100"
              value={watermarkParams.opacity}
              onChange={(e) => setWatermarkParams({ 
                ...watermarkParams, 
                opacity: parseInt(e.target.value) 
              })}
            />
          </div>
          
          <div className="control-group">
            <label>大小: {watermarkParams.scale}%</label>
            <input
              type="range"
              min="0"
              max="100"
              value={watermarkParams.scale}
              onChange={(e) => setWatermarkParams({ 
                ...watermarkParams, 
                scale: parseInt(e.target.value) 
              })}
            />
          </div>
          
          <div className="control-group">
            <label>旋转: {watermarkParams.rotation}°</label>
            <input
              type="range"
              min="0"
              max="360"
              value={watermarkParams.rotation}
              onChange={(e) => setWatermarkParams({ 
                ...watermarkParams, 
                rotation: parseInt(e.target.value) 
              })}
            />
          </div>
          
          <button 
            className="apply-button"
            disabled={!originalImage || isProcessing}
            onClick={addSmartWatermark}
          >
            {isProcessing ? '添加中...' : '添加水印'}
          </button>
        </div>
      </div>
    </div>
  );
}
```

#### 3.3.2 位置选择器 PositionSelector.tsx
```tsx
import React from 'react';

interface Position {
  x: number | 'auto';
  y: number | 'auto';
  corner?: 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right' | 'center';
}

interface PositionSelectorProps {
  position: Position;
  onPositionChange: (position: Position) => void;
}

export function PositionSelector({ position, onPositionChange }: PositionSelectorProps) {
  const presetPositions = [
    { id: 'top-left', label: '左上角', corner: 'top-left' },
    { id: 'top-right', label: '右上角', corner: 'top-right' },
    { id: 'bottom-left', label: '左下角', corner: 'bottom-left' },
    { id: 'bottom-right', label: '右下角', corner: 'bottom-right' },
    { id: 'center', label: '居中', corner: 'center' }
  ];

  return (
    <div className="position-selector">
      <h3>水印位置</h3>
      <div className="position-presets">
        {presetPositions.map((preset) => (
          <button
            key={preset.id}
            className={`preset-button ${position.corner === preset.corner ? 'selected' : ''}`}
            onClick={() => onPositionChange({ 
              x: 'auto', 
              y: 'auto', 
              corner: preset.corner as any 
            })}
          >
            {preset.label}
          </button>
        ))}
      </div>
      
      <div className="position-custom">
        <div className="coordinate-input">
          <label>X坐标:</label>
          <input
            type="number"
            min="0"
            max="100"
            value={typeof position.x === 'number' ? position.x : ''}
            onChange={(e) => onPositionChange({ 
              ...position, 
              x: e.target.value ? parseInt(e.target.value) : 'auto' 
            })}
            placeholder="自动"
          />
          <span>%</span>
        </div>
        
        <div className="coordinate-input">
          <label>Y坐标:</label>
          <input
            type="number"
            min="0"
            max="100"
            value={typeof position.y === 'number' ? position.y : ''}
            onChange={(e) => onPositionChange({ 
              ...position, 
              y: e.target.value ? parseInt(e.target.value) : 'auto' 
            })}
            placeholder="自动"
          />
          <span>%</span>
        </div>
      </div>
    </div>
  );
}
```

## 4. 状态管理设计

### 4.1 Zustand Store 扩展
```typescript
// stores/watermarkSlice.ts
import { create } from 'zustand';
import { devtools } from 'zustand/middleware';

interface TextWatermarkParams {
  text: string;
  font: string;
  fontSize: number;
  color: string;
  fontStyle: 'normal' | 'bold' | 'italic';
}

interface ImageWatermarkParams {
  src: string;
  width?: number;
  height?: number;
}

interface Position {
  x: number | 'auto';
  y: number | 'auto';
  corner?: 'top-left' | 'top-right' | 'bottom-left' | 'bottom-right' | 'center';
}

interface WatermarkParams {
  watermarkType: 'text' | 'image';
  textWatermark?: TextWatermarkParams;
  imageWatermark?: ImageWatermarkParams;
  position: Position;
  opacity: number;
  scale: number;
  rotation: number;
}

interface WatermarkState {
  originalImage: string | null;
  watermarkedImage: string | null;
  watermarkParams: WatermarkParams;
  isProcessing: boolean;
  setOriginalImage: (image: string) => void;
  setWatermarkParams: (params: WatermarkParams) => void;
  addSmartWatermark: () => Promise<void>;
}

export const useWatermarkStore = create<WatermarkState>()(
  devtools((set, get) => ({
    originalImage: null,
    watermarkedImage: null,
    watermarkParams: {
      watermarkType: 'text',
      textWatermark: {
        text: '© Watermark',
        font: 'Arial',
        fontSize: 24,
        color: '#FFFFFF',
        fontStyle: 'normal'
      },
      position: {
        x: 'auto',
        y: 'auto',
        corner: 'bottom-right'
      },
      opacity: 50,
      scale: 100,
      rotation: 0
    },
    isProcessing: false,
    
    setOriginalImage: (image) => set({ originalImage: image }),
    
    setWatermarkParams: (params) => set({ watermarkParams: params }),
    
    addSmartWatermark: async () => {
      const { originalImage, watermarkParams } = get();
      if (!originalImage) return;
      
      set({ isProcessing: true });
      
      try {
        const result = await addSmartWatermark({
          imageSrc: originalImage,
          ...watermarkParams
        });
        
        set({ 
          watermarkedImage: result.imageSrc,
          isProcessing: false 
        });
      } catch (error) {
        set({ isProcessing: false });
        throw error;
      }
    }
  }))
);
```

## 5. UI/UX 设计

### 5.1 界面布局
```
+---------------------------------------------------------------+
| 智能水印添加工具                                              |
+-----------+----------------------+---------------------------+
| 设置面板  | 预览区域             | 控制面板                  |
|           |                      |                           |
| [文字水印] | [图片预览区域]       | [透明度: 50% ----o]       |
| [图片水印] |                      | [大小: 100% ----o]        |
|           |                      | [旋转: 0° ----o]          |
| 文字设置  |                      |                           |
| 文字: ©   |                      | 位置选择:                 |
| 字体: A   |                      | [左上] [右上] [居中]      |
| 大小: 24  |                      | [左下] [右下]             |
| 颜色: W   |                      |                           |
+-----------+----------------------+---------------------------+
| [上传图片] [添加水印] [下载结果]                              |
+---------------------------------------------------------------+
```

### 5.2 交互流程
1. 用户上传需要添加水印的图片
2. 选择水印类型（文字/图片）
3. 设置水印内容和样式
4. 选择水印位置或自定义坐标
5. 调整透明度、大小和旋转角度
6. 实时预览水印效果
7. 点击"添加水印"按钮
8. 显示处理进度
9. 展示添加水印后的图片
10. 提供下载和继续编辑选项

## 6. 开发计划

### 6.1 第一阶段：基础框架搭建 (1周)
- [ ] 创建组件结构和文件
- [ ] 实现 Zustand 状态管理
- [ ] 设计 UI 组件
- [ ] 实现图片上传功能

### 6.2 第二阶段：核心功能开发 (2周)
- [ ] 实现文字水印功能
- [ ] 实现图片水印功能
- [ ] 实现智能位置识别
- [ ] 实现透明度调节

### 6.3 第三阶段：增强功能开发 (1周)
- [ ] 实现大小适配功能
- [ ] 实现旋转功能
- [ ] 添加批量处理功能
- [ ] 优化处理性能

### 6.4 第四阶段：测试与优化 (1周)
- [ ] 功能测试
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 文档完善

## 7. 测试方案

### 7.1 单元测试
- 测试状态管理功能
- 测试水印参数验证逻辑
- 测试位置计算逻辑

### 7.2 集成测试
- 测试完整的水印添加流程
- 测试不同水印类型的效果
- 测试批量处理功能

### 7.3 用户验收测试
- 邀请摄影师测试水印效果
- 收集用户反馈
- 优化用户体验

## 8. 部署与维护

### 8.1 部署要求
- 确保302.AI API密钥配置正确
- 验证图像上传和处理功能
- 测试不同浏览器兼容性

### 8.2 维护计划
- 监控API调用情况
- 收集用户反馈并持续优化
- 定期更新水印模板库